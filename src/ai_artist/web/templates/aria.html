<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Aria - An autonomous AI artist with genuine personality, evolving moods, and creative independence.">
    <title>Aria | Autonomous AI Artist</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé®</text></svg>">

    <style>
        :root {
            --bg-dark: #0a0a0a;
            --bg-panel: #141414;
            --text-main: #e0e0e0;
            --text-muted: #9a9a9a; /* Improved contrast: was #888888 */
            --accent: #bb86fc;
            --accent-glow: rgba(187, 134, 252, 0.2);
            --accent-hover: #d4a8ff;
            --border: #333;
            --success: #00ff64;
            --warning: #ffc800;
            --danger: #ff3264;
            --focus-ring: rgba(187, 134, 252, 0.5);
            --xp-bar: linear-gradient(90deg, #bb86fc, #6c63ff);
        }

        /* Light theme */
        [data-theme="light"] {
            --bg-dark: #f5f5f5;
            --bg-panel: #ffffff;
            --text-main: #1a1a1a;
            --text-muted: #666666;
            --border: #e0e0e0;
            --accent-glow: rgba(139, 92, 246, 0.15);
        }

        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            :root {
                --bg-dark: #000000;
                --bg-panel: #0a0a0a;
                --text-main: #ffffff;
                --text-muted: #cccccc;
                --border: #ffffff;
                --accent: #ffff00;
                --accent-hover: #ffffff;
            }
        }

        /* Forced Colors Mode (Windows High Contrast) */
        @media (forced-colors: active) {
            .orb {
                forced-color-adjust: none;
                border: 2px solid CanvasText;
            }
            .btn, button {
                border: 2px solid ButtonText;
            }
        }

        /* Accessibility: Reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            top: -100%;
            left: 0;
            background: var(--accent);
            color: #000;
            padding: 0.5rem 1rem;
            z-index: 9999;
            font-weight: 600;
            text-decoration: none;
            border-radius: 0 0 8px 0;
        }
        .skip-link:focus {
            top: 0;
        }

        /* Focus styles for accessibility */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Remove outline for mouse users */
        :focus:not(:focus-visible) {
            outline: none;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* === LEFT PANEL: THE MIND === */
        .mind-panel {
            width: 420px;
            background-color: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 2rem;
            z-index: 10;
            box-shadow: 5px 0 30px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        header {
            margin-bottom: 1.5rem;
        }

        h1 {
            font-family: 'Space Mono', monospace;
            font-size: 2rem;
            margin: 0;
            letter-spacing: -1px;
            background: linear-gradient(45deg, #fff, var(--accent));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-family: 'Space Mono', monospace;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        /* Mood Orb */
        .mood-container {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .orb {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 30px var(--accent-glow);
            transition: all 1s ease;
            position: relative;
            flex-shrink: 0;
        }

        .orb::after {
            content: '';
            position: absolute;
            inset: -5px;
            border-radius: 50%;
            background: inherit;
            filter: blur(10px);
            opacity: 0.5;
            z-index: -1;
            animation: pulse 4s infinite ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 0.3; }
        }

        .mood-info { flex: 1; }
        .mood-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .mood-value {
            font-size: 1.2rem;
            font-weight: 600;
            text-transform: capitalize;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-bottom: 0.3rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
        }

        /* Personality Traits */
        .personality-section {
            margin-bottom: 1.5rem;
        }

        .section-header {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 0.75rem;
        }

        .trait-bar {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            gap: 0.5rem;
        }

        .trait-name {
            font-size: 0.7rem;
            width: 100px;
            color: var(--text-muted);
        }

        .trait-track {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .trait-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            transition: width 1s ease;
        }

        .trait-value {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            width: 35px;
            text-align: right;
        }

        /* Stream of Consciousness */
        .stream-container {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding-right: 0.5rem;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
            min-height: 150px;
        }

        .stream-container::-webkit-scrollbar {
            width: 4px;
        }

        .stream-container::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 2px;
        }

        .log-entry {
            margin-bottom: 1rem;
            font-size: 0.85rem;
            line-height: 1.5;
            animation: fadeIn 0.5s ease;
        }

        .log-meta {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--accent);
            margin-bottom: 0.2rem;
            opacity: 0.7;
        }

        .log-content {
            color: #ccc;
        }

        /* Page Transitions */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .mind-panel {
            animation: slideIn 0.4s ease-out;
        }

        .gallery-panel {
            animation: fadeIn 0.5s ease-out;
        }

        .art-card {
            animation: fadeIn 0.3s ease-out;
            animation-fill-mode: both;
        }

        /* Stagger animation for gallery cards */
        .art-card:nth-child(1) { animation-delay: 0.05s; }
        .art-card:nth-child(2) { animation-delay: 0.1s; }
        .art-card:nth-child(3) { animation-delay: 0.15s; }
        .art-card:nth-child(4) { animation-delay: 0.2s; }
        .art-card:nth-child(5) { animation-delay: 0.25s; }
        .art-card:nth-child(6) { animation-delay: 0.3s; }

        /* Modal Transitions */
        .modal, .lightbox {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.active, .lightbox.active {
            opacity: 1;
        }

        .modal-content, .lightbox-content {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal.active .modal-content, .lightbox.active .lightbox-content {
            transform: scale(1);
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 0.75rem;
            margin-top: auto;
        }

        button {
            background: var(--text-main);
            color: #000;
            border: none;
            padding: 0.875rem 1.25rem;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 0.8rem;
            cursor: pointer;
            transition: transform 0.15s ease, opacity 0.2s, box-shadow 0.2s;
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        /* Button ripple effect */
        button::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            transform: scale(0);
            opacity: 0;
            transition: transform 0.4s ease, opacity 0.4s ease;
        }
        button:active::after {
            transform: scale(2);
            opacity: 1;
            transition: 0s;
        }

        button:hover {
            opacity: 0.95;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        button:active { transform: translateY(0); }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button:focus-visible {
            box-shadow: 0 0 0 3px var(--focus-ring);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn-outline:hover {
            border-color: var(--accent);
            color: var(--accent-hover);
        }

        /* Experience/Level Display */
        .experience-section {
            margin-bottom: 1.5rem;
            background: rgba(255, 255, 255, 0.02);
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .level-display {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .level-badge {
            background: var(--xp-bar);
            color: #000;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 0.75rem;
            padding: 0.35rem 0.6rem;
            border-radius: 6px;
            min-width: 45px;
            text-align: center;
        }

        .level-title {
            font-size: 0.85rem;
            color: var(--text-main);
            font-weight: 500;
        }

        .xp-bar-container {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .xp-bar-fill {
            height: 100%;
            background: var(--xp-bar);
            border-radius: 3px;
            transition: width 0.5s ease;
            position: relative;
        }

        .xp-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(rgba(255,255,255,0.2), transparent);
        }

        .xp-text {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 0.35rem;
            text-align: right;
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-panel) 25%, rgba(255,255,255,0.1) 50%, var(--bg-panel) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-card {
            height: 250px;
            margin-bottom: 1rem;
        }

        /* Style Axes Visualization */
        .style-axes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .style-axis {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .axis-name {
            font-size: 0.6rem;
            color: var(--text-muted);
            width: 70px;
            text-transform: capitalize;
        }

        .axis-bar {
            flex: 1;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .axis-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Intensity indicator on mood orb */
        .intensity-ring {
            position: absolute;
            inset: -8px;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: var(--accent);
            animation: intensityRotate 2s linear infinite;
            opacity: 0.6;
        }

        @keyframes intensityRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .low-intensity .intensity-ring { animation-duration: 4s; opacity: 0.3; }
        .high-intensity .intensity-ring { animation-duration: 1s; opacity: 0.9; }

        /* Mood Influence */
        .mood-influence {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .influence-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.75rem;
        }
        .influence-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .influence-btn {
            flex: 1;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .influence-btn:hover {
            background: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--accent-glow);
        }
        .influence-btn:active {
            transform: translateY(0);
        }
        .influence-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* === RIGHT PANEL: GALLERY === */
        .gallery-panel {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background: radial-gradient(circle at top right, #1a1a1a, #0a0a0a);
        }

        .masonry-grid {
            column-count: 3;
            column-gap: 1.5rem;
        }

        .art-card {
            break-inside: avoid;
            margin-bottom: 1.5rem;
            background: var(--bg-panel);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .art-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .art-img {
            width: 100%;
            display: block;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .art-info {
            padding: 1rem;
        }

        .art-title {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.4rem;
            text-transform: uppercase;
        }

        .art-prompt {
            font-size: 0.85rem;
            color: #ddd;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .tags {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .tag {
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
        }

        /* Loading Overlay */
        #creating-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #creating-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .loader {
            color: var(--accent);
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            letter-spacing: 5px;
            animation: pulseText 1.5s infinite;
        }

        @keyframes pulseText {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Lightbox */
        .lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            padding: 2rem;
        }

        .lightbox.active {
            opacity: 1;
            pointer-events: all;
        }

        .lightbox-content {
            background: var(--bg-panel);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            display: flex;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .lightbox.active .lightbox-content {
            transform: scale(1);
        }

        .lightbox-body {
            display: flex;
            width: 100%;
        }

        .lightbox-img-container {
            flex: 1.5;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .lightbox-img-container img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }

        .lightbox-details {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            border-left: 1px solid var(--border);
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: #fff;
            font-size: 2rem;
            cursor: pointer;
            z-index: 10;
            padding: 0.5rem;
            line-height: 1;
        }

        #lb-title {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            margin-top: 0;
            text-transform: capitalize;
            color: #fff;
        }

        .lb-meta {
            margin-top: 1.5rem;
        }

        .lb-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            letter-spacing: 2px;
            margin-bottom: 0.4rem;
            text-transform: uppercase;
        }

        #lb-reflection {
            font-size: 1rem;
            line-height: 1.6;
            color: #ddd;
        }

        /* Thinking Section */
        .thinking-section {
            background: rgba(255, 255, 255, 0.03);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .thinking-header {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--accent);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
        }

        .thinking-icon {
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .thinking-content {
            font-size: 0.8rem;
            line-height: 1.6;
            color: var(--text-main);
            white-space: pre-wrap;
        }

        /* Critique Dialogue */
        .critique-entry {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
        }

        .critique-speaker {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--accent);
            margin-bottom: 0.4rem;
            text-transform: uppercase;
        }

        .critique-text {
            font-size: 0.8rem;
            line-height: 1.5;
            color: var(--text-main);
        }

        .approval-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-family: 'Space Mono', monospace;
            margin-left: 0.5rem;
        }

        .approved { background: rgba(0, 255, 100, 0.2); color: var(--success); }
        .revised { background: rgba(255, 200, 0, 0.2); color: var(--warning); }

        /* Statement Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2.5rem;
            max-width: 600px;
            position: relative;
        }

        .modal-content h2 {
            font-family: 'Space Mono', monospace;
            color: var(--accent);
            margin-top: 0;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .modal-text {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #ddd;
            font-style: italic;
        }

        .modal-meta {
            margin-top: 1.5rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-close:hover { color: #fff; }

        /* Lightbox Actions */
        .lightbox-actions {
            display: flex;
            gap: 0.75rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-main);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: var(--accent);
            color: #000;
            transform: translateY(-2px);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Variations Modal */
        .variations-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .variation-card {
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .variation-card:hover {
            transform: scale(1.02);
        }

        .variation-card img {
            width: 100%;
            height: auto;
            display: block;
        }

        .variation-label {
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            font-size: 0.75rem;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .masonry-grid { column-count: 2; }
        }

        @media (max-width: 900px) {
            body { flex-direction: column; height: auto; overflow: auto; }
            .mind-panel {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border);
                max-height: 50vh;
            }
            .masonry-grid { column-count: 1; }
            .lightbox-body { flex-direction: column; }
            .lightbox-content { flex-direction: column; max-height: 95vh; overflow-y: auto; }
            .lightbox-img-container img { max-height: 50vh; }
        }

        @media (max-width: 480px) {
            .mind-panel { padding: 1rem; }
            h1 { font-size: 1.5rem; }
            .orb { width: 50px; height: 50px; }
        }
    </style>
</head>
<body>
    <!-- Skip link for accessibility -->
    <a href="#gallery-grid" class="skip-link">Skip to Gallery</a>

    <!-- LEFT PANEL: MIND -->
    <aside class="mind-panel" role="complementary" aria-label="Aria's Mind">
        <header>
            <a href="/aria" style="text-decoration: none; color: inherit;" aria-label="Aria home">
                <h1>ARIA</h1>
            </a>
            <div class="subtitle" role="doc-subtitle">Autonomous AI Artist</div>
            <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                <span class="theme-icon">‚òÄÔ∏è</span>
            </button>
        </header>

        <!-- Mood Orb -->
        <div class="mood-container" role="status" aria-live="polite" aria-label="Current emotional state">
            <div id="mood-orb" class="orb" role="img" aria-label="Mood visualization orb">
                <div class="intensity-ring" aria-hidden="true"></div>
            </div>
            <div class="mood-info">
                <div class="mood-label" id="mood-label">Current Mood</div>
                <div id="mood-text" class="mood-value" aria-labelledby="mood-label">Awakening...</div>
                <div id="intensity-text" style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.2rem;"></div>
            </div>
        </div>

        <!-- Mood Influence Buttons -->
        <div class="mood-influence" role="group" aria-label="Influence Aria's mood">
            <div class="influence-label">Influence Her Mood</div>
            <div class="influence-buttons">
                <button class="influence-btn" onclick="influenceMood('energize')" title="Energize" aria-label="Energize Aria's mood">&#9889;</button>
                <button class="influence-btn" onclick="influenceMood('calm')" title="Calm" aria-label="Calm Aria's mood">&#127754;</button>
                <button class="influence-btn" onclick="influenceMood('provoke')" title="Provoke" aria-label="Provoke Aria's mood">&#128293;</button>
                <button class="influence-btn" onclick="influenceMood('inspire')" title="Inspire" aria-label="Inspire Aria's mood">&#10024;</button>
            </div>
        </div>

        <!-- Experience/Level Section -->
        <div class="experience-section" role="status" aria-label="Experience progress">
            <div class="level-display">
                <div id="level-badge" class="level-badge" aria-label="Current level">L1</div>
                <div id="level-title" class="level-title">Novice Artist</div>
            </div>
            <div class="xp-bar-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Experience progress">
                <div id="xp-bar" class="xp-bar-fill" style="width: 0%"></div>
            </div>
            <div id="xp-text" class="xp-text">0 / 100 XP</div>

            <!-- Style Axes -->
            <div id="style-axes-container" class="style-axes" role="group" aria-label="Creative style axes">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid" role="group" aria-label="Statistics">
            <div class="stat-card">
                <div class="stat-label" id="energy-label">Energy</div>
                <div id="energy-val" class="stat-value" aria-labelledby="energy-label">--%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label" id="creations-label">Creations</div>
                <div id="count-val" class="stat-value" aria-labelledby="creations-label">--</div>
            </div>
        </div>

        <!-- Personality Traits (OCEAN) -->
        <div class="personality-section" id="personality-section" role="group" aria-label="Personality traits">
            <div class="section-header">Personality</div>
            <div id="personality-traits" role="list">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Stream of Consciousness -->
        <div class="section-header">Stream of Consciousness</div>
        <div id="thought-stream" class="stream-container">
            <div class="log-entry">
                <div class="log-meta">SYSTEM</div>
                <div class="log-content">Neural pathways initializing...</div>
            </div>
        </div>

        <!-- Controls -->
        <nav class="controls" role="group" aria-label="Primary actions">
            <button id="create-btn" onclick="triggerCreate()" aria-describedby="create-desc">CREATE</button>
            <span id="create-desc" hidden>Trigger Aria to create a new artwork</span>
            <button class="btn-outline" onclick="showStatement()" title="Artist Statement" aria-label="View artist statement">?</button>
        </nav>
        <nav class="controls" style="margin-top: 0.75rem;" role="group" aria-label="Secondary actions">
            <button class="btn-outline" onclick="forceEvolve()" aria-label="Evolve Aria's state">EVOLVE</button>
            <button class="btn-outline" onclick="showEvolution()" aria-label="View evolution timeline">TIMELINE</button>
            <button class="btn-outline" onclick="showMemory()" aria-label="View memory dashboard">MEMORY</button>
            <button class="btn-outline" onclick="window.open('/', '_blank')" aria-label="Open full gallery in new tab">FULL GALLERY</button>
        </nav>
    </aside>

    <!-- RIGHT PANEL: GALLERY -->
    <main class="gallery-panel" role="main" aria-label="Artwork gallery">
        <div id="gallery-grid" class="masonry-grid" role="list" aria-label="Recent artworks">
            <!-- Art cards injected here -->
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="creating-overlay">
        <div style="text-align: center;">
            <div class="loader" id="loader-text">DREAMING...</div>
            <div style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-muted); font-family: 'Space Mono';" id="loader-status">Beginning creative process</div>
        </div>
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox(event)" role="dialog" aria-modal="true" aria-labelledby="lb-title" aria-hidden="true">
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <button class="close-btn" onclick="closeLightbox()" aria-label="Close lightbox">&times;</button>
            <div class="lightbox-body">
                <div class="lightbox-img-container">
                    <img id="lb-img" src="" alt="Artwork detail view">
                </div>
                <div class="lightbox-details">
                    <h2 id="lb-title"></h2>
                    <div class="tags" id="lb-tags" role="list" aria-label="Artwork tags"></div>
                    <!-- Action Buttons -->
                    <div class="lightbox-actions" id="lb-actions">
                        <button class="action-btn" onclick="generateVariations()" title="Generate Variations">
                            <span>&#127912;</span> Variations
                        </button>
                        <button class="action-btn" onclick="downloadArtwork()" title="Download">
                            <span>&#11015;&#65039;</span> Download
                        </button>
                        <button class="action-btn" onclick="shareArtwork()" title="Share">
                            <span>&#128279;</span> Share
                        </button>
                    </div>
                    <div class="lb-meta">
                        <div class="lb-label" id="reflection-label">Reflection</div>
                        <p id="lb-reflection" aria-labelledby="reflection-label"></p>
                    </div>
                    <div id="lb-thinking" class="thinking-section" style="display:none;">
                        <div class="thinking-header">
                            <div class="thinking-icon" aria-hidden="true"></div>
                            Thought Process
                        </div>
                        <div id="lb-thinking-content" class="thinking-content"></div>
                    </div>
                    <div id="lb-critique" class="thinking-section" style="display:none;">
                        <div class="thinking-header">
                            <div class="thinking-icon" aria-hidden="true"></div>
                            Creative Dialogue
                        </div>
                        <div id="lb-critique-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard navigation handler -->
    <script>
        // Keyboard accessibility
        document.addEventListener('keydown', (e) => {
            // Escape to close lightbox/modals
            if (e.key === 'Escape') {
                const lightbox = document.getElementById('lightbox');
                const statementModal = document.getElementById('statement-modal');
                const evolutionModal = document.getElementById('evolution-modal');

                if (lightbox && lightbox.classList.contains('active')) {
                    closeLightbox();
                } else if (statementModal && statementModal.classList.contains('active')) {
                    closeStatement();
                } else if (evolutionModal && evolutionModal.classList.contains('active')) {
                    closeEvolution();
                }
            }
        });

        // Trap focus in modals for accessibility
        function trapFocus(element) {
            const focusableElements = element.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];

            element.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    if (e.shiftKey && document.activeElement === firstFocusable) {
                        e.preventDefault();
                        lastFocusable.focus();
                    } else if (!e.shiftKey && document.activeElement === lastFocusable) {
                        e.preventDefault();
                        firstFocusable.focus();
                    }
                }
            });
        }
    </script>

    <script>
        // Utility: Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Mood colors
        const MOOD_COLORS = {
            contemplative: "#7B8FA1",
            energized: "#FFD93D",
            melancholic: "#4B56D2",
            chaotic: "#FF6B6B",
            serene: "#A8D1D1",
            restless: "#FF8E4F",
            introspective: "#5F6F94",
            rebellious: "#FF0032",
            playful: "#F7A4A4",
            bold: "#FFD700"
        };

        // State
        let paintingsData = {};
        let ws = null;
        let currentLightboxId = null;

        // WebSocket connection
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(protocol + '//' + window.location.host + '/ws');

            ws.onopen = function() {
                addLog('SYSTEM', 'Connected to Aria\'s consciousness');
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (e) {
                    console.error('WebSocket parse error:', e);
                }
            };

            ws.onclose = function() {
                addLog('SYSTEM', 'Connection lost, reconnecting...');
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'thinking_update':
                    addLog('THINKING', data.thought || data.message || '');
                    break;
                case 'aria_state':
                    updateMoodDisplay(data);
                    break;
                case 'critique_update':
                    if (data.critique) {
                        var status = data.approved ? 'APPROVED' : 'REVISION';
                        addLog('CRITIQUE', '[' + status + '] ' + data.critique);
                    }
                    break;
                case 'creation_complete':
                    addLog('ARIA', data.reflection || 'Creation complete');
                    fetchState(true);
                    break;
                case 'progress':
                    document.getElementById('loader-status').textContent = data.message || 'Processing...';
                    break;
                case 'generation_progress':
                    var pct = data.progress_percent || Math.round((data.step / data.total_steps) * 100);
                    document.getElementById('loader-status').textContent =
                        'Generating: ' + pct + '% (' + data.step + '/' + data.total_steps + ')';
                    if (data.step % 10 === 0) {
                        addLog('GENERATING', 'Step ' + data.step + '/' + data.total_steps + ' (' + pct + '%)');
                    }
                    break;
                case 'generation_complete':
                    addLog('ARIA', 'Generation complete');
                    fetchState(true);
                    break;
                case 'error':
                    addLog('ERROR', data.error || data.message || 'Unknown error');
                    break;
                case 'mood_drift':
                    addLog('MOOD', 'Mood naturally drifted to ' + data.mood);
                    updateMoodDisplay({ mood: data.mood, intensity: data.intensity });
                    break;
                case 'memory_insight':
                    addLog('INSIGHT', data.insight);
                    break;
            }
        }

        function addLog(source, text) {
            var stream = document.getElementById('thought-stream');
            var entry = document.createElement('div');
            entry.className = 'log-entry';
            var time = new Date().toLocaleTimeString();

            var meta = document.createElement('div');
            meta.className = 'log-meta';
            meta.textContent = source + ' \u2022 ' + time;

            var content = document.createElement('div');
            content.className = 'log-content';
            content.textContent = text;

            entry.appendChild(meta);
            entry.appendChild(content);
            stream.insertBefore(entry, stream.firstChild);

            // Keep only last 50 entries
            while (stream.children.length > 50) {
                stream.removeChild(stream.lastChild);
            }
        }

        function updateMoodDisplay(data) {
            var mood = data.mood || 'contemplative';
            var color = MOOD_COLORS[mood] || '#bb86fc';

            document.getElementById('mood-text').textContent = mood;
            var orb = document.getElementById('mood-orb');
            orb.style.backgroundColor = color;
            orb.style.boxShadow = '0 0 30px ' + color + '66';

            if (data.energy !== undefined) {
                document.getElementById('energy-val').textContent = Math.round(data.energy * 100) + '%';
            }

            // Update mood intensity display
            var intensity = data.mood_intensity || data.intensity || 0.5;
            var intensityText = document.getElementById('intensity-text');
            if (intensityText) {
                var intensityLabel = intensity > 0.7 ? 'Intense' : (intensity > 0.4 ? 'Moderate' : 'Fading');
                intensityText.textContent = 'Intensity: ' + Math.round(intensity * 100) + '% (' + intensityLabel + ')';
            }

            // Update intensity ring animation class
            if (intensity > 0.7) {
                orb.classList.add('high-intensity');
                orb.classList.remove('low-intensity');
            } else if (intensity < 0.4) {
                orb.classList.add('low-intensity');
                orb.classList.remove('high-intensity');
            } else {
                orb.classList.remove('high-intensity', 'low-intensity');
            }
        }

        function updateExperienceDisplay(data) {
            // Update from experience data in state
            var exp = data.experience || {};
            var level = exp.level || data.level || 1;
            var title = exp.title || data.title || 'Novice Artist';
            var totalXp = exp.total_xp || 0;
            var progress = exp.progress_percent || 0;
            var xpInLevel = exp.xp_in_level || 0;
            var xpForNext = exp.xp_for_next_level || 100;

            document.getElementById('level-badge').textContent = 'L' + level;
            document.getElementById('level-title').textContent = title;
            document.getElementById('xp-bar').style.width = progress + '%';
            document.getElementById('xp-text').textContent = xpInLevel + ' / ' + xpForNext + ' XP';

            // Update ARIA attributes
            var xpBar = document.querySelector('.xp-bar-container');
            if (xpBar) {
                xpBar.setAttribute('aria-valuenow', progress);
            }
        }

        function updateStyleAxesDisplay(styleAxes) {
            if (!styleAxes) return;

            var container = document.getElementById('style-axes-container');
            if (!container) return;

            container.textContent = '';

            // Friendly labels for axes
            var axisLabels = {
                abstraction: 'Abstract',
                saturation: 'Saturated',
                complexity: 'Complex',
                drama: 'Dramatic',
                symmetry: 'Symmetric',
                novelty: 'Novel',
                line_quality: 'Sharp',
                palette_temperature: 'Warm',
                motion: 'Dynamic',
                symbolism: 'Symbolic'
            };

            Object.keys(styleAxes).forEach(function(axis) {
                var value = styleAxes[axis] || 0.5;
                var pct = Math.round(value * 100);

                var axisEl = document.createElement('div');
                axisEl.className = 'style-axis';

                var name = document.createElement('span');
                name.className = 'axis-name';
                name.textContent = axisLabels[axis] || axis;
                axisEl.appendChild(name);

                var bar = document.createElement('div');
                bar.className = 'axis-bar';

                var fill = document.createElement('div');
                fill.className = 'axis-fill';
                fill.style.width = pct + '%';
                bar.appendChild(fill);
                axisEl.appendChild(bar);

                container.appendChild(axisEl);
            });
        }

        function updatePersonalityDisplay(personality) {
            if (!personality) return;

            var traits = [
                { key: 'openness', label: 'Openness' },
                { key: 'conscientiousness', label: 'Conscientious' },
                { key: 'extraversion', label: 'Extraversion' },
                { key: 'agreeableness', label: 'Agreeable' },
                { key: 'neuroticism', label: 'Neuroticism' }
            ];

            var container = document.getElementById('personality-traits');
            container.textContent = ''; // Clear safely

            traits.forEach(function(t) {
                var value = personality[t.key] || 0.5;
                var pct = Math.round(value * 100);

                var bar = document.createElement('div');
                bar.className = 'trait-bar';

                var name = document.createElement('span');
                name.className = 'trait-name';
                name.textContent = t.label;

                var track = document.createElement('div');
                track.className = 'trait-track';

                var fill = document.createElement('div');
                fill.className = 'trait-fill';
                fill.style.width = pct + '%';
                track.appendChild(fill);

                var val = document.createElement('span');
                val.className = 'trait-value';
                val.textContent = pct + '%';

                bar.appendChild(name);
                bar.appendChild(track);
                bar.appendChild(val);
                container.appendChild(bar);
            });
        }

        function fetchState(loadGallery) {
            fetch('/api/aria/state')
                .then(function(res) {
                    if (!res.ok) throw new Error('Failed to fetch state');
                    return res.json();
                })
                .then(function(data) {
                    updateMoodDisplay(data);

                    if (data.paintings_created !== undefined) {
                        document.getElementById('count-val').textContent = data.paintings_created;
                    }

                    if (data.personality) {
                        updatePersonalityDisplay(data.personality);
                    }

                    // Update experience/level display
                    updateExperienceDisplay(data);

                    // Update style axes display
                    if (data.style_axes) {
                        updateStyleAxesDisplay(data.style_axes);
                    }

                    if (loadGallery && data.portfolio) {
                        renderGallery(data.portfolio);
                    }
                })
                .catch(function(e) {
                    console.error('Error fetching state:', e);
                    // Fallback to images API
                    if (loadGallery) {
                        fetch('/api/images?limit=50&_t=' + Date.now())
                            .then(function(res) { return res.json(); })
                            .then(function(images) { renderGalleryFromImages(images); })
                            .catch(function(err) { console.error('Error fetching images:', err); });
                    }
                });
        }

        function renderGallery(portfolio) {
            var grid = document.getElementById('gallery-grid');
            grid.textContent = '';

            // API already returns newest first, no need to reverse
            // Reset paintingsData to ensure clean state
            paintingsData = {};
            portfolio.forEach(function(p, i) {
                // Always use iteration index, not p.number which may be stale
                paintingsData[i] = p;
                grid.appendChild(createArtCard(p, i));
            });
        }

        function renderGalleryFromImages(images) {
            var grid = document.getElementById('gallery-grid');
            grid.textContent = '';

            // Reset paintingsData to ensure clean state
            paintingsData = {};
            images.forEach(function(img, i) {
                var painting = {
                    number: i,
                    subject: (img.prompt && img.prompt.split(',')[0]) || 'Artwork',
                    prompt: img.prompt || '',
                    image_url: img.full_url || img.thumbnail_url,
                    mood: (img.metadata && img.metadata.mood) || 'contemplative',
                    style: (img.metadata && img.metadata.style) || 'digital art',
                    reflection: (img.metadata && img.metadata.reflection) || img.prompt
                };
                paintingsData[i] = painting;
                grid.appendChild(createArtCard(painting, i));
            });
        }

        function createArtCard(painting, id) {
            var div = document.createElement('div');
            div.className = 'art-card';
            div.onclick = function() { openLightbox(id); };
            div.setAttribute('tabindex', '0');
            div.setAttribute('role', 'button');
            div.setAttribute('aria-label', (painting.subject || 'Untitled') + ' - ' + (painting.mood || 'artwork'));
            // Add keyboard handler
            div.onkeydown = function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    openLightbox(id);
                }
            };

            var imgSrc = painting.image_url || painting.full_url;
            if (!imgSrc) {
                imgSrc = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" fill="%23333"><rect width="400" height="300"/><text x="50%" y="50%" fill="%23666" text-anchor="middle">No Image</text></svg>';
            } else if (imgSrc.indexOf('http') !== 0 && imgSrc.indexOf('/') !== 0 && imgSrc.indexOf('data:') !== 0) {
                imgSrc = '/' + imgSrc;
            }

            var mood = painting.mood || 'contemplative';
            var moodColor = MOOD_COLORS[mood] || '#888';

            var img = document.createElement('img');
            img.src = imgSrc;
            img.className = 'art-img';
            img.loading = 'lazy';
            img.onerror = function() { this.style.display = 'none'; };
            div.appendChild(img);

            var info = document.createElement('div');
            info.className = 'art-info';

            var title = document.createElement('div');
            title.className = 'art-title';
            title.textContent = painting.subject || 'Untitled';
            info.appendChild(title);

            var prompt = document.createElement('div');
            prompt.className = 'art-prompt';
            prompt.textContent = painting.reflection || painting.prompt || '';
            info.appendChild(prompt);

            var tags = document.createElement('div');
            tags.className = 'tags';

            var moodTag = document.createElement('span');
            moodTag.className = 'tag';
            moodTag.style.background = moodColor + '33';
            moodTag.style.color = moodColor;
            moodTag.textContent = mood;
            tags.appendChild(moodTag);

            var styleTag = document.createElement('span');
            styleTag.className = 'tag';
            styleTag.textContent = painting.style || 'digital';
            tags.appendChild(styleTag);

            info.appendChild(tags);
            div.appendChild(info);

            return div;
        }

        function openLightbox(id) {
            currentGalleryIndex = id;
            currentLightboxId = id;
            var painting = paintingsData[id];
            if (!painting) return;

            var imgSrc = painting.image_url || painting.full_url;
            if (imgSrc && imgSrc.indexOf('http') !== 0 && imgSrc.indexOf('/') !== 0) {
                imgSrc = '/' + imgSrc;
            }

            document.getElementById('lb-img').src = imgSrc || '';
            document.getElementById('lb-title').textContent = painting.subject || 'Untitled';
            document.getElementById('lb-reflection').textContent = painting.reflection || painting.prompt || '';

            var mood = painting.mood || 'contemplative';
            var moodColor = MOOD_COLORS[mood] || '#888';

            var tagsEl = document.getElementById('lb-tags');
            tagsEl.textContent = '';

            var moodTag = document.createElement('span');
            moodTag.className = 'tag';
            moodTag.style.background = moodColor + '33';
            moodTag.style.color = moodColor;
            moodTag.textContent = mood;
            tagsEl.appendChild(moodTag);

            var styleTag = document.createElement('span');
            styleTag.className = 'tag';
            styleTag.textContent = painting.style || 'digital';
            tagsEl.appendChild(styleTag);

            // Show thinking if available
            var thinkingEl = document.getElementById('lb-thinking');
            var thinkingContent = document.getElementById('lb-thinking-content');
            if (painting.thinking && painting.thinking.narrative) {
                thinkingContent.textContent = painting.thinking.narrative;
                thinkingEl.style.display = 'block';
            } else {
                thinkingEl.style.display = 'none';
            }

            // Show critique if available
            var critiqueEl = document.getElementById('lb-critique');
            var critiqueContent = document.getElementById('lb-critique-content');
            if (painting.critique_history && painting.critique_history.length > 0) {
                critiqueContent.textContent = '';
                painting.critique_history.forEach(function(c) {
                    var entry = document.createElement('div');
                    entry.className = 'critique-entry';

                    var speaker = document.createElement('div');
                    speaker.className = 'critique-speaker';
                    speaker.textContent = (c.critic_name || 'Critic') + ' ';

                    var badge = document.createElement('span');
                    badge.className = 'approval-badge ' + (c.approved ? 'approved' : 'revised');
                    badge.textContent = c.approved ? 'APPROVED' : 'REVISION';
                    speaker.appendChild(badge);
                    entry.appendChild(speaker);

                    var text = document.createElement('div');
                    text.className = 'critique-text';
                    text.textContent = c.critique;
                    entry.appendChild(text);

                    critiqueContent.appendChild(entry);
                });
                critiqueEl.style.display = 'block';
            } else {
                critiqueEl.style.display = 'none';
            }

            document.getElementById('lightbox').classList.add('active');
        }

        function closeLightbox(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('lightbox').classList.remove('active');
        }

        function triggerCreate() {
            var btn = document.getElementById('create-btn');
            var overlay = document.getElementById('creating-overlay');

            btn.disabled = true;
            overlay.classList.add('active');
            addLog('SYSTEM', 'Initiating creative process...');

            var progressSteps = [
                'Contemplating the void...',
                'Channeling emotions...',
                'Mixing digital pigments...',
                'Applying brushstrokes...',
                'Adding final touches...'
            ];

            var stepIndex = 0;
            var progressInterval = setInterval(function() {
                if (stepIndex < progressSteps.length) {
                    document.getElementById('loader-status').textContent = progressSteps[stepIndex];
                    stepIndex++;
                }
            }, 3000);

            fetch('/api/aria/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(function(res) {
                clearInterval(progressInterval);
                if (!res.ok) {
                    return res.json().then(function(err) {
                        throw new Error(err.detail || 'Creation failed');
                    });
                }
                return res.json();
            })
            .then(function(data) {
                if (data.thinking) {
                    addLog('THINKING', data.thinking);
                }

                if (data.critique_history && data.critique_history.length > 0) {
                    data.critique_history.forEach(function(c) {
                        var status = c.approved ? 'APPROVED' : 'REVISION';
                        addLog('CRITIQUE', '[' + status + '] ' + c.critique);
                    });
                }

                addLog('ARIA', data.reflection || 'Creation complete');

                // Refresh gallery
                fetchState(true);
            })
            .catch(function(err) {
                clearInterval(progressInterval);
                addLog('ERROR', err.message);
            })
            .finally(function() {
                overlay.classList.remove('active');
                btn.disabled = false;
            });
        }

        function forceEvolve() {
            fetch('/api/aria/evolve', { method: 'POST' })
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data.mood) {
                        updateMoodDisplay(data);
                        addLog('EVOLUTION', 'Mood shifted to ' + data.mood);
                    }
                    if (data.personality) {
                        updatePersonalityDisplay(data.personality);
                    }
                })
                .catch(function(e) {
                    addLog('ERROR', 'Evolution failed');
                });
        }

        function influenceMood(influence) {
            var btn = event.target;
            btn.disabled = true;
            btn.style.opacity = '0.5';

            fetch('/api/aria/mood/influence', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ influence: influence, intensity: 0.7 })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                addLog('INFLUENCE', data.message);
                if (data.new_mood) {
                    updateMoodDisplay({ mood: data.new_mood });
                }
                // Refresh full state to get updated intensity and style axes
                fetchState(false);
            })
            .catch(function(err) {
                addLog('ERROR', 'Could not influence mood');
            })
            .finally(function() {
                setTimeout(function() {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }, 1000);
            });
        }

        function showStatement() {
            fetch('/api/aria/statement')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    var modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.onclick = function(e) { if (e.target === modal) modal.remove(); };

                    var content = document.createElement('div');
                    content.className = 'modal-content';

                    var closeBtn = document.createElement('button');
                    closeBtn.className = 'modal-close';
                    closeBtn.textContent = '\u00D7';
                    closeBtn.onclick = function() { modal.remove(); };
                    content.appendChild(closeBtn);

                    var h2 = document.createElement('h2');
                    h2.textContent = 'Artist Statement';
                    content.appendChild(h2);

                    var text = document.createElement('p');
                    text.className = 'modal-text';
                    text.textContent = data.statement || 'I am still finding my words...';
                    content.appendChild(text);

                    var meta = document.createElement('div');
                    meta.className = 'modal-meta';
                    meta.textContent = '- Aria, Autonomous AI Artist';
                    content.appendChild(meta);

                    modal.appendChild(content);
                    document.body.appendChild(modal);
                })
                .catch(function(e) {
                    addLog('ERROR', 'Could not fetch artist statement');
                });
        }

        function showEvolution() {
            fetch('/api/aria/evolution')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    var modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.onclick = function(e) { if (e.target === modal) modal.remove(); };

                    var content = document.createElement('div');
                    content.className = 'modal-content';
                    content.style.maxWidth = '800px';
                    content.style.maxHeight = '90vh';
                    content.style.overflow = 'auto';

                    var closeBtn = document.createElement('button');
                    closeBtn.className = 'modal-close';
                    closeBtn.textContent = '\u00D7';
                    closeBtn.onclick = function() { modal.remove(); };
                    content.appendChild(closeBtn);

                    var h2 = document.createElement('h2');
                    h2.textContent = 'Artistic Evolution';
                    h2.style.marginBottom = '1.5rem';
                    content.appendChild(h2);

                    // Summary stats
                    if (data.summary) {
                        var summary = document.createElement('div');
                        summary.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 2rem;';

                        var stats = [
                            { label: 'Creations', value: data.summary.total_creations || 0 },
                            { label: 'Styles', value: data.summary.unique_styles || 0 },
                            { label: 'Phases', value: data.summary.phases_count || 0 }
                        ];

                        stats.forEach(function(stat) {
                            var statBox = document.createElement('div');
                            statBox.style.cssText = 'background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 8px; text-align: center;';
                            var val = document.createElement('div');
                            val.style.cssText = 'font-size: 1.5rem; font-weight: 700; color: var(--accent);';
                            val.textContent = stat.value;
                            var lbl = document.createElement('div');
                            lbl.style.cssText = 'font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;';
                            lbl.textContent = stat.label;
                            statBox.appendChild(val);
                            statBox.appendChild(lbl);
                            summary.appendChild(statBox);
                        });
                        content.appendChild(summary);
                    }

                    // Milestones
                    if (data.milestones && data.milestones.length > 0) {
                        var milestonesSection = document.createElement('div');
                        milestonesSection.style.marginBottom = '2rem';

                        var milestonesTitle = document.createElement('h3');
                        milestonesTitle.textContent = 'Milestones';
                        milestonesTitle.style.cssText = 'font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.1em;';
                        milestonesSection.appendChild(milestonesTitle);

                        data.milestones.forEach(function(milestone) {
                            var item = document.createElement('div');
                            item.style.cssText = 'padding: 0.75rem 1rem; background: rgba(255,255,255,0.03); border-left: 3px solid var(--accent); margin-bottom: 0.5rem; border-radius: 0 4px 4px 0;';

                            var date = document.createElement('div');
                            date.style.cssText = 'font-size: 0.75rem; color: var(--text-muted);';
                            date.textContent = milestone.date || 'Unknown date';
                            item.appendChild(date);

                            var desc = document.createElement('div');
                            desc.style.cssText = 'font-size: 0.9rem; margin-top: 0.25rem;';
                            desc.textContent = milestone.description || milestone.type;
                            item.appendChild(desc);

                            milestonesSection.appendChild(item);
                        });
                        content.appendChild(milestonesSection);
                    }

                    // Phases
                    if (data.phases && data.phases.length > 0) {
                        var phasesSection = document.createElement('div');
                        phasesSection.style.marginBottom = '2rem';

                        var phasesTitle = document.createElement('h3');
                        phasesTitle.textContent = 'Artistic Phases';
                        phasesTitle.style.cssText = 'font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.1em;';
                        phasesSection.appendChild(phasesTitle);

                        data.phases.forEach(function(phase) {
                            var item = document.createElement('div');
                            item.style.cssText = 'display: flex; align-items: center; gap: 1rem; padding: 0.5rem 0;';

                            var dot = document.createElement('div');
                            dot.style.cssText = 'width: 12px; height: 12px; border-radius: 50%; background: var(--accent); flex-shrink: 0;';
                            item.appendChild(dot);

                            var info = document.createElement('div');
                            var name = document.createElement('div');
                            name.style.fontWeight = '500';
                            name.textContent = phase.name || (phase.mood + ' Period');
                            info.appendChild(name);

                            var dates = document.createElement('div');
                            dates.style.cssText = 'font-size: 0.75rem; color: var(--text-muted);';
                            dates.textContent = (phase.start_date || '') + ' \u2192 ' + (phase.end_date || 'Present');
                            info.appendChild(dates);

                            item.appendChild(info);
                            phasesSection.appendChild(item);
                        });
                        content.appendChild(phasesSection);
                    }

                    // Mood Distribution
                    if (data.mood_distribution && Object.keys(data.mood_distribution).length > 0) {
                        var moodSection = document.createElement('div');
                        moodSection.style.marginBottom = '2rem';

                        var moodTitle = document.createElement('h3');
                        moodTitle.textContent = 'Mood Distribution';
                        moodTitle.style.cssText = 'font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.1em;';
                        moodSection.appendChild(moodTitle);

                        var total = Object.values(data.mood_distribution).reduce(function(a, b) { return a + b; }, 0);
                        var sorted = Object.entries(data.mood_distribution).sort(function(a, b) { return b[1] - a[1]; });

                        sorted.forEach(function(entry) {
                            var mood = entry[0];
                            var count = entry[1];
                            var pct = Math.round((count / total) * 100);

                            var bar = document.createElement('div');
                            bar.style.cssText = 'margin-bottom: 0.5rem;';

                            var label = document.createElement('div');
                            label.style.cssText = 'display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;';
                            var moodName = document.createElement('span');
                            moodName.textContent = mood;
                            var moodPct = document.createElement('span');
                            moodPct.style.color = 'var(--text-muted)';
                            moodPct.textContent = pct + '%';
                            label.appendChild(moodName);
                            label.appendChild(moodPct);
                            bar.appendChild(label);

                            var track = document.createElement('div');
                            track.style.cssText = 'height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;';
                            var fill = document.createElement('div');
                            fill.style.cssText = 'height: 100%; background: var(--accent); border-radius: 3px; transition: width 0.3s;';
                            fill.style.width = pct + '%';
                            track.appendChild(fill);
                            bar.appendChild(track);

                            moodSection.appendChild(bar);
                        });
                        content.appendChild(moodSection);
                    }

                    // Empty state
                    if (!data.milestones || data.milestones.length === 0) {
                        var empty = document.createElement('p');
                        empty.style.cssText = 'text-align: center; color: var(--text-muted); padding: 2rem;';
                        empty.textContent = 'My evolution story is just beginning... Create more art to see my journey unfold.';
                        content.appendChild(empty);
                    }

                    modal.appendChild(content);
                    document.body.appendChild(modal);
                })
                .catch(function(e) {
                    console.error('Evolution fetch error:', e);
                    addLog('ERROR', 'Could not fetch evolution data');
                });
        }

        function showMemory() {
            fetch('/api/aria/memory')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    var modal = document.createElement('div');
                    modal.className = 'modal active';
                    modal.onclick = function(e) { if (e.target === modal) modal.remove(); };

                    var content = document.createElement('div');
                    content.className = 'modal-content';
                    content.style.maxWidth = '700px';
                    content.style.maxHeight = '90vh';
                    content.style.overflow = 'auto';

                    var closeBtn = document.createElement('button');
                    closeBtn.className = 'modal-close';
                    closeBtn.textContent = '\u00D7';
                    closeBtn.onclick = function() { modal.remove(); };
                    content.appendChild(closeBtn);

                    var h2 = document.createElement('h2');
                    h2.textContent = 'Memory & Learning';
                    h2.style.marginBottom = '1.5rem';
                    content.appendChild(h2);

                    // Recent Memories Section
                    var memoriesSection = document.createElement('div');
                    memoriesSection.style.marginBottom = '2rem';

                    var memoriesTitle = document.createElement('h3');
                    memoriesTitle.textContent = 'Recent Insights';
                    memoriesTitle.style.cssText = 'font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.1em;';
                    memoriesSection.appendChild(memoriesTitle);

                    if (data.recent_memories && data.recent_memories.length > 0) {
                        data.recent_memories.forEach(function(mem) {
                            var item = document.createElement('div');
                            item.style.cssText = 'padding: 0.75rem 1rem; background: rgba(255,255,255,0.03); border-left: 3px solid var(--accent); margin-bottom: 0.5rem; border-radius: 0 4px 4px 0;';

                            var badge = document.createElement('span');
                            badge.style.cssText = 'font-size: 0.65rem; background: var(--accent); color: #000; padding: 0.15rem 0.5rem; border-radius: 10px; margin-right: 0.5rem;';
                            badge.textContent = mem.type.toUpperCase();
                            item.appendChild(badge);

                            var text = document.createElement('span');
                            text.style.fontSize = '0.9rem';
                            text.textContent = mem.content;
                            item.appendChild(text);

                            memoriesSection.appendChild(item);
                        });
                    } else {
                        var empty = document.createElement('p');
                        empty.style.cssText = 'color: var(--text-muted); font-style: italic;';
                        empty.textContent = 'Building memories through creation...';
                        memoriesSection.appendChild(empty);
                    }
                    content.appendChild(memoriesSection);

                    // Patterns Section
                    if (data.patterns && data.patterns.length > 0) {
                        var patternsSection = document.createElement('div');
                        patternsSection.style.marginBottom = '2rem';

                        var patternsTitle = document.createElement('h3');
                        patternsTitle.textContent = 'Learned Patterns';
                        patternsTitle.style.cssText = 'font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.1em;';
                        patternsSection.appendChild(patternsTitle);

                        var patternsList = document.createElement('ul');
                        patternsList.style.cssText = 'list-style: none; padding: 0;';

                        data.patterns.forEach(function(pattern) {
                            var li = document.createElement('li');
                            li.style.cssText = 'padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem;';
                            li.textContent = '\u2726 ' + pattern;
                            patternsList.appendChild(li);
                        });

                        patternsSection.appendChild(patternsList);
                        content.appendChild(patternsSection);
                    }

                    // Preferences Section
                    if (data.learned_preferences && Object.keys(data.learned_preferences).length > 0) {
                        var prefsSection = document.createElement('div');

                        var prefsTitle = document.createElement('h3');
                        prefsTitle.textContent = 'Preferences';
                        prefsTitle.style.cssText = 'font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.1em;';
                        prefsSection.appendChild(prefsTitle);

                        var prefsGrid = document.createElement('div');
                        prefsGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem;';

                        Object.entries(data.learned_preferences).forEach(function(entry) {
                            var key = entry[0];
                            var value = entry[1];
                            var pref = document.createElement('div');
                            pref.style.cssText = 'background: rgba(139, 92, 246, 0.1); padding: 0.75rem; border-radius: 8px; text-align: center;';

                            var label = document.createElement('div');
                            label.style.cssText = 'font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.25rem;';
                            label.textContent = key;
                            pref.appendChild(label);

                            var val = document.createElement('div');
                            val.style.cssText = 'font-size: 0.9rem; color: var(--accent);';
                            val.textContent = value;
                            pref.appendChild(val);

                            prefsGrid.appendChild(pref);
                        });

                        prefsSection.appendChild(prefsGrid);
                        content.appendChild(prefsSection);
                    }

                    modal.appendChild(content);
                    document.body.appendChild(modal);
                })
                .catch(function(e) {
                    addLog('ERROR', 'Could not fetch memory data');
                });
        }

        function showMoodGraph() {
            fetch('/api/aria/mood/evolution')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    var modal = document.createElement('div');
                    modal.className = 'modal active';
                    modal.onclick = function(e) { if (e.target === modal) modal.remove(); };

                    var content = document.createElement('div');
                    content.className = 'modal-content';
                    content.style.maxWidth = '800px';

                    var closeBtn = document.createElement('button');
                    closeBtn.className = 'modal-close';
                    closeBtn.textContent = '\u00D7';
                    closeBtn.onclick = function() { modal.remove(); };
                    content.appendChild(closeBtn);

                    var h2 = document.createElement('h2');
                    h2.textContent = 'Mood Evolution';
                    h2.style.marginBottom = '1.5rem';
                    content.appendChild(h2);

                    // Current state
                    var current = document.createElement('div');
                    current.style.cssText = 'display: flex; gap: 2rem; margin-bottom: 2rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 12px;';

                    var currentMood = document.createElement('div');
                    currentMood.innerHTML = '<div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Current Mood</div><div style="font-size: 1.5rem; color: var(--accent); text-transform: capitalize;">' + (data.current_mood || 'unknown') + '</div>';
                    current.appendChild(currentMood);

                    var stability = document.createElement('div');
                    var stabilityPct = Math.round((data.mood_stability || 0) * 100);
                    stability.innerHTML = '<div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Stability</div><div style="font-size: 1.5rem;">' + stabilityPct + '%</div>';
                    current.appendChild(stability);

                    var dominant = document.createElement('div');
                    dominant.innerHTML = '<div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Dominant</div><div style="font-size: 1.5rem; text-transform: capitalize;">' + (data.dominant_mood || 'unknown') + '</div>';
                    current.appendChild(dominant);

                    content.appendChild(current);

                    // Mood Distribution bars
                    if (data.mood_distribution && Object.keys(data.mood_distribution).length > 0) {
                        var distSection = document.createElement('div');
                        distSection.style.marginBottom = '2rem';

                        var distTitle = document.createElement('h3');
                        distTitle.textContent = 'Mood Distribution';
                        distTitle.style.cssText = 'font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem;';
                        distSection.appendChild(distTitle);

                        var total = Object.values(data.mood_distribution).reduce(function(a, b) { return a + b; }, 0);
                        var sorted = Object.entries(data.mood_distribution).sort(function(a, b) { return b[1] - a[1]; });

                        sorted.forEach(function(entry) {
                            var mood = entry[0];
                            var count = entry[1];
                            var pct = Math.round((count / total) * 100);
                            var moodColor = MOOD_COLORS[mood] || '#888';

                            var bar = document.createElement('div');
                            bar.style.marginBottom = '0.5rem';

                            var label = document.createElement('div');
                            label.style.cssText = 'display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;';
                            label.innerHTML = '<span style="text-transform: capitalize;">' + mood + '</span><span style="color: var(--text-muted);">' + pct + '%</span>';
                            bar.appendChild(label);

                            var track = document.createElement('div');
                            track.style.cssText = 'height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;';

                            var fill = document.createElement('div');
                            fill.style.cssText = 'height: 100%; border-radius: 4px; transition: width 0.5s;';
                            fill.style.width = pct + '%';
                            fill.style.background = moodColor;
                            track.appendChild(fill);
                            bar.appendChild(track);

                            distSection.appendChild(bar);
                        });

                        content.appendChild(distSection);
                    }

                    // Recent History Timeline
                    if (data.history && data.history.length > 0) {
                        var histSection = document.createElement('div');

                        var histTitle = document.createElement('h3');
                        histTitle.textContent = 'Recent History';
                        histTitle.style.cssText = 'font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem;';
                        histSection.appendChild(histTitle);

                        var timeline = document.createElement('div');
                        timeline.style.cssText = 'display: flex; gap: 4px; flex-wrap: wrap;';

                        data.history.slice(-30).forEach(function(entry) {
                            var dot = document.createElement('div');
                            var moodColor = MOOD_COLORS[entry.mood] || '#888';
                            dot.style.cssText = 'width: 20px; height: 20px; border-radius: 4px; cursor: pointer;';
                            dot.style.background = moodColor;
                            dot.style.opacity = entry.intensity;
                            dot.title = entry.mood + ' (' + Math.round(entry.intensity * 100) + '%)';
                            timeline.appendChild(dot);
                        });

                        histSection.appendChild(timeline);

                        var legend = document.createElement('div');
                        legend.style.cssText = 'margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-muted);';
                        legend.textContent = 'Each square represents a mood state. Opacity indicates intensity.';
                        histSection.appendChild(legend);

                        content.appendChild(histSection);
                    }

                    modal.appendChild(content);
                    document.body.appendChild(modal);
                })
                .catch(function(e) {
                    addLog('ERROR', 'Could not fetch mood evolution');
                });
        }

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('aria-theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.querySelector('.theme-icon');
            if (icon) {
                icon.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            }
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('aria-theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'dark');
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeIcon(theme);
        }

        // Gallery keyboard navigation
        let currentGalleryIndex = -1;
        const galleryCards = () => document.querySelectorAll('.art-card');

        document.addEventListener('keydown', function(e) {
            const lightbox = document.getElementById('lightbox');
            const isLightboxOpen = lightbox && lightbox.classList.contains('active');

            if (isLightboxOpen) {
                // Navigate between images in lightbox
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    e.preventDefault();
                    const cards = galleryCards();
                    const direction = e.key === 'ArrowLeft' ? -1 : 1;
                    currentGalleryIndex = Math.max(0, Math.min(cards.length - 1, currentGalleryIndex + direction));
                    openLightbox(currentGalleryIndex);
                }
            } else {
                // Focus gallery with 'g' key
                if (e.key === 'g' && !e.ctrlKey && !e.metaKey) {
                    const firstCard = document.querySelector('.art-card');
                    if (firstCard) {
                        firstCard.focus();
                        currentGalleryIndex = 0;
                    }
                }
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeLightbox();
                var modal = document.querySelector('.modal');
                if (modal) modal.remove();
            }
        });

        // Variations, Download, Share functions
        function generateVariations() {
            if (currentLightboxId === null) return;

            var painting = paintingsData[currentLightboxId];
            if (!painting || !painting.id) {
                addLog('ERROR', 'Cannot generate variations - no image ID');
                return;
            }

            var btn = event.target.closest('.action-btn');
            btn.disabled = true;
            btn.textContent = '';
            var loadingSpan = document.createElement('span');
            loadingSpan.textContent = '\u23F3';
            btn.appendChild(loadingSpan);
            btn.appendChild(document.createTextNode(' Generating...'));

            fetch('/api/aria/variations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    image_id: painting.id,
                    count: 4,
                    variation_type: 'style'
                })
            })
            .then(function(res) {
                if (!res.ok) throw new Error('Failed to generate variations');
                return res.json();
            })
            .then(function(data) {
                addLog('ARIA', 'Generated ' + data.variations.length + ' variations');
                showVariationsModal(data.variations);
                fetchState(true); // Refresh gallery
            })
            .catch(function(err) {
                addLog('ERROR', err.message);
            })
            .finally(function() {
                btn.disabled = false;
                btn.textContent = '';
                var iconSpan = document.createElement('span');
                iconSpan.textContent = '\uD83C\uDFA8';
                btn.appendChild(iconSpan);
                btn.appendChild(document.createTextNode(' Variations'));
            });
        }

        function showVariationsModal(variations) {
            var modal = document.createElement('div');
            modal.className = 'modal active';
            modal.onclick = function(e) { if (e.target === modal) modal.remove(); };

            var content = document.createElement('div');
            content.className = 'modal-content';
            content.style.maxWidth = '700px';

            var closeBtn = document.createElement('button');
            closeBtn.className = 'modal-close';
            closeBtn.textContent = '\u00D7';
            closeBtn.onclick = function() { modal.remove(); };
            content.appendChild(closeBtn);

            var h2 = document.createElement('h2');
            h2.textContent = 'Style Variations';
            h2.style.marginBottom = '1rem';
            content.appendChild(h2);

            var grid = document.createElement('div');
            grid.className = 'variations-grid';

            variations.forEach(function(v) {
                var card = document.createElement('div');
                card.className = 'variation-card';

                var img = document.createElement('img');
                img.src = v.image_url;
                img.alt = v.description;
                card.appendChild(img);

                var label = document.createElement('div');
                label.className = 'variation-label';
                label.textContent = v.description;
                card.appendChild(label);

                card.onclick = function() {
                    window.open(v.image_url, '_blank');
                };

                grid.appendChild(card);
            });

            content.appendChild(grid);
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function downloadArtwork() {
            if (currentLightboxId === null) return;

            var painting = paintingsData[currentLightboxId];
            var imgSrc = painting.image_url || painting.full_url;

            if (imgSrc) {
                var link = document.createElement('a');
                link.href = imgSrc.indexOf('/') === 0 ? imgSrc : '/' + imgSrc;
                link.download = (painting.subject || 'aria-artwork') + '.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                addLog('SYSTEM', 'Download started');
            }
        }

        function shareArtwork() {
            if (currentLightboxId === null) return;

            var painting = paintingsData[currentLightboxId];
            var shareUrl = window.location.origin + '/gallery/' + (painting.share_id || painting.id);

            if (navigator.share) {
                navigator.share({
                    title: painting.subject || 'Aria Artwork',
                    text: painting.reflection || 'Created by Aria, an autonomous AI artist',
                    url: shareUrl
                }).catch(function() {});
            } else {
                navigator.clipboard.writeText(shareUrl).then(function() {
                    addLog('SYSTEM', 'Share link copied to clipboard');
                });
            }
        }

        // Mobile touch gestures for lightbox
        var touchStartX = 0;
        var touchEndX = 0;

        document.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        document.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        function handleSwipe() {
            var lightbox = document.getElementById('lightbox');
            if (!lightbox || !lightbox.classList.contains('active')) return;

            var swipeThreshold = 50;
            var diff = touchStartX - touchEndX;

            if (Math.abs(diff) > swipeThreshold) {
                var cards = galleryCards();
                var direction = diff > 0 ? 1 : -1; // Swipe left = next, swipe right = prev
                currentGalleryIndex = Math.max(0, Math.min(cards.length - 1, currentGalleryIndex + direction));
                openLightbox(currentGalleryIndex);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            fetchState(true);
            connectWebSocket();
            setInterval(function() { fetchState(false); }, 10000);
        });
    </script>
</body>
</html>
