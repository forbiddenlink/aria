<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Browse and explore a curated collection of AI-generated artwork. Discover unique digital art created with cutting-edge AI models and machine learning.">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="{{ request.url }}">

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="AI Artist Gallery - Modern Collection">
    <meta property="og:description" content="Browse and explore a curated collection of AI-generated artwork. Discover unique digital art created with cutting-edge AI models.">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:image" content="{{ request.url.scheme }}://{{ request.url.netloc }}/api/images/og-preview.png">
    <meta property="og:site_name" content="AI Artist Gallery">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="AI Artist Gallery - Modern Collection">
    <meta name="twitter:description" content="Browse and explore a curated collection of AI-generated artwork.">
    <meta name="twitter:image" content="{{ request.url.scheme }}://{{ request.url.netloc }}/api/images/og-preview.png">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¨</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¨</text></svg>">

    <title>AI Artist Gallery - Modern Collection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Accessibility: Screen reader only class for form labels */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus visible for keyboard users */
        :focus-visible {
            outline: 2px solid var(--accent, #58a6ff);
            outline-offset: 2px;
        }

        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #0f1419;
            --bg-card: #161d27;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent: #58a6ff;
            --accent-hover: #1f6feb;
            --accent-light: #79c0ff;
            --accent-secondary: #56d4dd;
            --accent-tertiary: #f2cc60;
            --border: #21262d;
            --success: #3fb950;
            --danger: #f85149;
            --warning: #d29922;
            --shadow: rgba(0, 0, 0, 0.7);
            --glow: rgba(88, 166, 255, 0.4);
            --glow-mint: rgba(86, 212, 221, 0.35);
            --glow-gold: rgba(242, 204, 96, 0.3);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Animated gradient background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 10%, rgba(0, 217, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(192, 132, 252, 0.06) 0%, transparent 55%),
                radial-gradient(circle at 50% 90%, rgba(255, 107, 157, 0.07) 0%, transparent 50%),
                radial-gradient(circle at 10% 60%, rgba(0, 217, 255, 0.05) 0%, transparent 60%);
            z-index: -1;
            animation: backgroundFloat 25s ease-in-out infinite;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(135deg, transparent 0%, rgba(0, 217, 255, 0.02) 50%, transparent 100%),
                linear-gradient(-135deg, transparent 0%, rgba(255, 107, 157, 0.02) 50%, transparent 100%);
            z-index: -1;
            animation: gradientShift 20s ease-in-out infinite;
        }

        @keyframes backgroundFloat {
            0%, 100% { 
                opacity: 0.6;
                transform: scale(1) translateY(0);
            }
            33% { 
                opacity: 0.8;
                transform: scale(1.05) translateY(-10px);
            }
            66% { 
                opacity: 0.7;
                transform: scale(1.08) translateY(5px);
            }
        }

        @keyframes gradientShift {
            0%, 100% { transform: translateX(0) translateY(0); }
            50% { transform: translateX(20px) translateY(-20px); }
        }

        /* Header */
        .header {
            background: rgba(19, 19, 26, 0.95);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            padding: 24px 48px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            font-size: 26px;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 50%, var(--accent-tertiary) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0;
            font-weight: 800;
            color: white;
            box-shadow: 0 8px 24px var(--glow), 0 4px 16px var(--glow-pink);
            animation: logoFloat 3s ease infinite, logoPulse 2s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }

        .logo-icon svg {
            width: 28px;
            height: 28px;
            position: relative;
            z-index: 2;
        }

        @keyframes logoPulse {
            0%, 100% { box-shadow: 0 8px 24px var(--glow), 0 4px 16px var(--glow-pink); }
            50% { box-shadow: 0 12px 36px var(--glow), 0 6px 24px var(--glow-purple); }
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shine 3s ease infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        .stats {
            display: flex;
            gap: 32px;
        }

        .stat {
            text-align: center;
            padding: 8px 20px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent-light);
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        /* Controls */
        .controls {
            max-width: 1800px;
            margin: 0 auto;
            padding: 32px 48px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }

        .search-container {
            flex: 1;
            min-width: 300px;
            max-width: 600px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 16px 24px;
            padding-left: 52px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: var(--text-secondary);
        }

        .controls-right {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .sort-select {
            padding: 12px 20px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sort-select:hover {
            border-color: var(--accent);
        }

        .sort-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .view-toggle {
            display: flex;
            gap: 8px;
            background: var(--bg-card);
            padding: 6px;
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        .view-btn {
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            font-weight: 600;
        }

        .view-btn:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent-light);
        }

        .view-btn.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            color: white;
            box-shadow: 0 4px 12px var(--glow);
        }

        /* Gallery Grid */
        .gallery-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 48px 80px;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 28px;
            opacity: 0;
            animation: fadeIn 0.8s ease forwards;
        }

        .gallery.compact {
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .gallery.large {
            grid-template-columns: repeat(auto-fill, minmax(550px, 1fr));
            gap: 32px;
        }

        .gallery.masonry {
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            grid-auto-rows: 10px;
        }

        .gallery.masonry .gallery-item {
            grid-row-end: span var(--row-span);
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .gallery-item {
            background: var(--bg-card);
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .gallery-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
            z-index: 1;
        }

        .gallery-item:hover::before {
            opacity: 1;
        }

        .gallery-item:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 24px 48px rgba(99, 102, 241, 0.3);
            border-color: var(--accent);
        }

        .gallery-item-image-container {
            position: relative;
            overflow: hidden;
        }

        .gallery-item img {
            width: 100%;
            height: 240px;
            object-fit: cover;
            display: block;
            transition: transform 0.6s ease;
        }

        .gallery.large .gallery-item img {
            height: 320px;
        }

        .gallery.compact .gallery-item img {
            height: 180px;
        }

        .gallery.masonry .gallery-item img {
            height: auto;
        }

        .gallery-item:hover img {
            transform: scale(1.08);
        }

        .gallery-item-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 2;
        }

        .gallery-item:hover .gallery-item-actions {
            opacity: 1;
            transform: translateY(0);
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.95);
            color: #1a1a24;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .action-btn.featured {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
        }

        .action-btn.delete {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .action-btn.download {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .featured-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 2;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .gallery-item-info {
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        .gallery-item-prompt {
            font-size: 15px;
            color: var(--text-primary);
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .gallery-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Loading Spinner */
        .loading {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 100px 20px;
            color: var(--text-secondary);
            font-size: 16px;
        }

        .spinner {
            width: 56px;
            height: 56px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Advanced Filters */
        .advanced-filters {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin: 0 40px 30px 40px;
            display: none;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .filter-section {
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-label svg {
            color: var(--accent);
        }

        .filter-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-input,
        .filter-select {
            flex: 1;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .filter-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
        }

        .filter-select {
            cursor: pointer;
        }

        .filter-toggle-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 18px;
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            margin-right: 12px;
        }

        .filter-toggle-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        .filter-toggle-btn.active {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.15), rgba(192, 132, 252, 0.15));
            border-color: var(--accent);
        }

        .filter-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: auto;
        }

        .filter-clear-btn {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .filter-clear-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .filter-count {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Live Preview Progress Panel */
        .progress-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            background: var(--bg-card);
            border: 2px solid var(--accent);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 20px rgba(0, 217, 255, 0.2);
            z-index: 2000;
            display: none;
            animation: slideInUp 0.3s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .progress-panel.active {
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .progress-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-status {
            font-size: 12px;
            padding: 4px 12px;
            background: rgba(0, 217, 255, 0.2);
            border-radius: 12px;
            color: var(--accent);
            font-weight: 700;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
            border-radius: 4px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px var(--accent);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .progress-message {
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .progress-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .progress-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }

        .progress-btn:hover {
            background: var(--bg-hover);
        }

        .progress-btn.danger {
            border-color: #ff4081;
            color: #ff4081;
        }

        .progress-btn.danger:hover {
            background: rgba(255, 64, 129, 0.1);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(16px);
            z-index: 1000;
            padding: 0;
            overflow: hidden;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 60px;
            background: rgba(99, 102, 241, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            color: white;
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .modal-nav-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 8px 24px var(--glow);
        }

        .modal-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        .modal-nav-prev {
            left: 20px;
        }

        .modal-nav-next {
            right: 20px;
        }

        .modal-image-counter {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 20px;
            border: 1px solid var(--border);
            color: white;
            font-weight: 700;
            font-size: 14px;
            z-index: 1001;
        }

        .modal-zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 1001;
        }

        .modal-zoom-btn {
            width: 48px;
            height: 48px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-zoom-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            transform: scale(1.1);
        }

        .modal-zoom-level {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 24px;
            border: 1px solid var(--border);
            color: white;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .modal-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 100px;
        }

        .modal-image-container {
            position: relative;
            max-width: 90%;
            max-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: move;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 14px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
        }

        .modal-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px var(--glow);
        }

        .modal-close {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            width: 52px;
            height: 52px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 28px;
            line-height: 1;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: #ef4444;
            border-color: #ef4444;
            color: white;
            transform: rotate(90deg);
        }

        .modal-image {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 12px;
            display: block;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            transition: transform 0.3s ease;
            object-fit: contain;
        }

        .modal-info {
            position: absolute;
            right: 0;
            top: 0;
            width: 400px;
            max-width: 90vw;
            height: 100%;
            padding: 80px 30px 30px;
            background: rgba(13, 13, 18, 0.98);
            backdrop-filter: blur(20px);
            border-left: 2px solid var(--border);
            overflow-y: auto;
            overflow-x: hidden;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .modal-info.visible {
            transform: translateX(0);
        }

        .modal-info h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--text-primary);
            line-height: 1.5;
            font-weight: 700;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .modal-info p {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 600;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .modal-info strong {
            color: var(--accent-light);
            word-wrap: break-word;
        }

        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-actions button {
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal-info-toggle {
            position: absolute;
            top: 20px;
            right: 420px;
            width: 48px;
            height: 48px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .modal-info-toggle:hover {
            background: var(--accent);
            border-color: var(--accent);
            transform: scale(1.1);
        }

        /* Empty State */
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 120px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 96px;
            margin-bottom: 24px;
            opacity: 0.6;
            animation: float 3s ease infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        .empty-state h2 {
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 28px;
            font-weight: 800;
        }

        .empty-state p {
            font-size: 16px;
            font-weight: 500;
        }

        /* Scroll to top button */
        .scroll-top {
            position: fixed;
            bottom: 40px;
            right: 40px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--accent), var(--accent-tertiary));
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            box-shadow: 0 8px 24px var(--glow), 0 0 40px var(--glow-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
        }

        .scroll-top.visible {
            opacity: 1;
            pointer-events: all;
        }

        .scroll-top:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 32px var(--glow);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 16px 32px;
            border-radius: 12px;
            border: 2px solid var(--border);
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.6);
            z-index: 2000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--danger);
        }

        .toast.info {
            border-color: var(--accent);
        }

        /* Keyboard shortcut display */
        kbd {
            display: inline-block;
            padding: 4px 8px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Courier New', monospace;
            font-size: 13px;
            font-weight: 600;
            line-height: 1;
            color: var(--text-primary);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4), inset 0 -2px 0 rgba(0, 0, 0, 0.3);
            min-width: 24px;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                padding: 20px 24px;
            }

            .logo {
                font-size: 22px;
            }

            .stats {
                width: 100%;
                justify-content: space-around;
                gap: 16px;
            }

            .controls {
                padding: 24px;
                flex-direction: column;
            }

            .search-container {
                width: 100%;
                max-width: 100%;
            }

            .controls-right {
                width: 100%;
                justify-content: space-between;
            }

            .gallery-container {
                padding: 0 24px 60px;
            }

            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 20px;
            }

            .modal {
                padding: 20px;
            }

            .modal-content {
                padding: 24px;
            }

            .scroll-top {
                bottom: 24px;
                right: 24px;
                width: 48px;
                height: 48px;
            }

            /* Modal info sidebar - mobile responsive */
            .modal-info {
                width: 100%;
                max-width: 100%;
                height: auto;
                max-height: 50vh;
                top: auto;
                bottom: 0;
                padding: 20px;
                border-left: none;
                border-top: 2px solid var(--border);
                transform: translateY(100%);
            }

            .modal-info.visible {
                transform: translateY(0);
            }

            .modal-info-toggle {
                right: 20px;
                top: auto;
                bottom: calc(50vh + 10px);
            }

            .modal-info h3 {
                font-size: 16px;
            }

            .modal-info p {
                font-size: 12px;
            }

            .modal-image {
                max-height: 50vh;
            }

            .modal-zoom-controls {
                flex-wrap: wrap;
                gap: 8px;
            }

            .modal-zoom-btn {
                padding: 8px 12px;
                font-size: 14px;
            }
        }

        /* Toast animations */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Comparison Mode */
        .comparison-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
        }

        .comparison-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid var(--accent);
        }

        .comparison-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .comparison-content {
            display: flex;
            height: calc(100% - 80px);
            position: relative;
        }

        .comparison-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }

        .comparison-panel.slider-mode {
            position: absolute;
            width: 100%;
            height: 100%;
            padding: 0;
        }

        .comparison-image-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .comparison-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            cursor: grab;
        }

        .comparison-image:active {
            cursor: grabbing;
        }

        .comparison-slider {
            position: absolute;
            top: 0;
            left: 50%;
            bottom: 0;
            width: 4px;
            background: var(--accent);
            cursor: ew-resize;
            z-index: 10;
        }

        .comparison-slider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--glow);
        }

        .comparison-slider::after {
            content: 'â¬Œ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 20px;
            font-weight: bold;
            z-index: 1;
        }

        .comparison-metadata {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
        }

        .comparison-diff-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .comparison-diff-table th {
            text-align: left;
            padding: 8px;
            color: var(--text-secondary);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
        }

        .comparison-diff-table td {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .comparison-diff-table td:first-child {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .comparison-diff-table td.diff {
            background: rgba(255, 193, 7, 0.1);
            color: var(--accent-tertiary);
            font-weight: 700;
        }

        .mode-toggle {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .mode-toggle.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border-color: var(--accent);
            box-shadow: 0 4px 12px var(--glow);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <!-- Main star burst -->
                        <path d="M12 2v4M12 18v4M22 12h-4M6 12H2"></path>
                        <path d="M19.07 4.93l-2.83 2.83M7.76 16.24l-2.83 2.83M19.07 19.07l-2.83-2.83M7.76 7.76L4.93 4.93"></path>
                        <!-- Inner circle -->
                        <circle cx="12" cy="12" r="3" fill="currentColor"></circle>
                        <!-- Sparkle accents -->
                        <path d="M12 1v1M12 22v1M23 12h-1M2 12H1"></path>
                    </svg>
                </div>
                <h1 style="font-size: inherit; font-weight: inherit; margin: 0;">AI Artist Gallery</h1>
            </div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="total-images">0</div>
                    <div class="stat-label">Artworks</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="total-prompts">0</div>
                    <div class="stat-label">Themes</div>
                </div>
                <button onclick="showShortcutsModal()" style="
                    background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(192, 132, 252, 0.1));
                    border: 1px solid var(--accent);
                    border-radius: 10px;
                    padding: 10px 20px;
                    color: var(--text-primary);
                    cursor: pointer;
                    font-weight: 600;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.3s;
                " onmouseover="this.style.background='linear-gradient(135deg, rgba(0, 217, 255, 0.2), rgba(192, 132, 252, 0.2))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(192, 132, 252, 0.1))'">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="4" width="20" height="16" rx="2" ry="2"></rect>
                        <line x1="6" y1="8" x2="6.01" y2="8"></line>
                        <line x1="10" y1="8" x2="10.01" y2="8"></line>
                        <line x1="14" y1="8" x2="14.01" y2="8"></line>
                        <line x1="18" y1="8" x2="18.01" y2="8"></line>
                        <line x1="8" y1="12" x2="8.01" y2="12"></line>
                        <line x1="12" y1="12" x2="12.01" y2="12"></line>
                        <line x1="16" y1="12" x2="16.01" y2="12"></line>
                        <line x1="7" y1="16" x2="17" y2="16"></line>
                    </svg>
                    Shortcuts
                </button>
                <button onclick="showTemplatesModal()" style="
                    margin-left: 12px;
                    background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(192, 132, 252, 0.1));
                    border: 1px solid var(--accent);
                    border-radius: 10px;
                    padding: 10px 20px;
                    color: var(--text-primary);
                    cursor: pointer;
                    font-weight: 600;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.3s;
                " onmouseover="this.style.background='linear-gradient(135deg, rgba(0, 217, 255, 0.2), rgba(192, 132, 252, 0.2))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(192, 132, 252, 0.1))'">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <line x1="10" y1="9" x2="8" y2="9"></line>
                    </svg>
                    Templates
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main id="main-content">

    <!-- Controls -->
    <div class="controls" role="search">
        <div class="search-container">
            <label for="search" class="sr-only">Search artworks</label>
            <span class="search-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </span>
            <input
                type="text"
                class="search-input"
                id="search"
                placeholder="Search artworks by prompt..."
                aria-label="Search artworks by prompt"
            >
        </div>
        <div class="controls-right">
            <label for="sort-select" class="sr-only">Sort order</label>
            <select class="sort-select" id="sort-select" aria-label="Sort order">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="prompt">By Prompt</option>
            </select>
            <button class="filter-toggle-btn" onclick="toggleAdvancedFilters()" title="Advanced Filters">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                </svg>
                Filters
            </button>
            <div class="view-toggle">
                <button class="view-btn active" data-view="grid" title="Grid View">âŠž</button>
                <button class="view-btn" data-view="compact" title="Compact View">âŠ¡</button>
                <button class="view-btn" data-view="large" title="Large View">âŠŸ</button>
                <button class="view-btn" data-view="masonry" title="Masonry View">âŠ </button>
            </div>
        </div>
    </div>

    <!-- Advanced Filters Panel -->
    <div class="advanced-filters" id="advanced-filters" style="display: none;">
        <div class="filter-section">
            <label class="filter-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                Date Range
            </label>
            <div class="filter-inputs">
                <label for="filter-date-from" class="sr-only">From date</label>
                <input type="date" id="filter-date-from" class="filter-input" placeholder="From" aria-label="From date">
                <span style="color: var(--text-secondary);">to</span>
                <label for="filter-date-to" class="sr-only">To date</label>
                <input type="date" id="filter-date-to" class="filter-input" placeholder="To" aria-label="To date">
            </div>
        </div>

        <div class="filter-section">
            <label class="filter-label" for="filter-lora">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="7.5 4.21 12 6.81 16.5 4.21"></polyline>
                    <polyline points="7.5 19.79 7.5 14.6 3 12"></polyline>
                    <polyline points="21 12 16.5 14.6 16.5 19.79"></polyline>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
                LoRA Model
            </label>
            <select id="filter-lora" class="filter-select" aria-label="LoRA Model filter">
                <option value="">All Models</option>
                <!-- Will be populated dynamically -->
            </select>
        </div>

        <div class="filter-section">
            <label class="filter-label" for="filter-dimensions">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="3" y1="9" x2="21" y2="9"></line>
                    <line x1="9" y1="21" x2="9" y2="9"></line>
                </svg>
                Dimensions
            </label>
            <div class="filter-inputs">
                <select id="filter-dimensions" class="filter-select" aria-label="Dimensions filter">
                    <option value="">All Sizes</option>
                    <option value="512x512">512x512 (Square)</option>
                    <option value="768x768">768x768 (Square)</option>
                    <option value="1024x1024">1024x1024 (Square)</option>
                    <option value="512x768">512x768 (Portrait)</option>
                    <option value="768x512">768x512 (Landscape)</option>
                    <option value="1024x768">1024x768 (Landscape)</option>
                    <option value="768x1024">768x1024 (Portrait)</option>
                </select>
            </div>
        </div>

        <div class="filter-section">
            <label class="filter-label" for="filter-featured">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
                Status
            </label>
            <select id="filter-featured" class="filter-select" aria-label="Status filter">
                <option value="">All</option>
                <option value="true">Featured Only</option>
                <option value="false">Non-Featured</option>
            </select>
        </div>

        <div class="filter-actions">
            <button class="filter-clear-btn" onclick="clearFilters()">Clear All</button>
            <span id="filter-count" class="filter-count"></span>
        </div>
    </div>

    <!-- Gallery -->
    <div class="gallery-container">
        <div class="gallery" id="gallery">
            <div class="loading">
                <div class="spinner"></div>
                Loading artworks...
            </div>
        </div>
    </div>

    </main>

    <!-- Live Preview Progress Panel -->
    <div class="progress-panel" id="progress-panel">
        <div class="progress-header">
            <div class="progress-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span id="progress-title-text">Generating Artwork</span>
            </div>
            <div class="progress-status" id="progress-status">In Progress</div>
        </div>
        
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>
        
        <div class="progress-info">
            <span id="progress-step-text">Step 0 of 0</span>
            <span id="progress-percent-text">0%</span>
        </div>
        
        <div class="progress-message" id="progress-message">
            Initializing...
        </div>
        
        <div class="progress-actions">
            <button class="progress-btn" onclick="hideProgressPanel()">Hide</button>
            <button class="progress-btn danger" id="cancel-btn" onclick="cancelGeneration()" disabled>
                Cancel Generation
            </button>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <button class="modal-close" onclick="closeModal()" style="position: absolute; top: 20px; left: 20px; z-index: 1001;">Ã—</button>
        
        <!-- Image counter -->
        <div class="modal-image-counter" id="modal-counter">1 of 10</div>
        
        <!-- Info toggle -->
        <button class="modal-info-toggle" id="modal-info-toggle" onclick="toggleModalInfo()" aria-label="Toggle image information panel">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
        </button>
        
        <!-- Navigation arrows -->
        <button class="modal-nav-btn modal-nav-prev" id="modal-prev" onclick="navigateModal(-1)">â€¹</button>
        <button class="modal-nav-btn modal-nav-next" id="modal-next" onclick="navigateModal(1)">â€º</button>
        
        <!-- Zoom controls -->
        <div class="modal-zoom-controls">
            <button class="modal-zoom-btn" onclick="zoomModal(-0.2)" title="Zoom out">âˆ’</button>
            <div class="modal-zoom-level" id="modal-zoom-level">100%</div>
            <button class="modal-zoom-btn" onclick="zoomModal(0.2)" title="Zoom in">+</button>
            <button class="modal-zoom-btn" onclick="resetZoom()" title="Reset zoom">âŸ²</button>
            <button class="modal-zoom-btn" onclick="startComparison()" title="Compare (C)" style="margin-left: 12px; font-size: 18px;">â‡†</button>
        </div>
        
        <div class="modal-content">
            <div class="modal-image-container" id="modal-image-container">
                <img class="modal-image" id="modal-image" src="" alt="" draggable="false">
            </div>
        </div>
        
        <!-- Info sidebar -->
        <div class="modal-info" id="modal-info">
            <div id="modal-info-content"></div>
            <div class="modal-actions" id="modal-actions" style="margin-top: 24px;">
                <!-- Actions will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Scroll to top -->
    <button class="scroll-top" id="scroll-top" onclick="scrollToTop()">â†‘</button>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <!-- Keyboard shortcuts help modal -->
    <div class="modal" id="shortcuts-modal" style="z-index: 2001;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 style="margin: 0; color: var(--text-primary);">âŒ¨ï¸ Keyboard Shortcuts</h2>
                <button class="modal-close" onclick="closeShortcutsModal()">Ã—</button>
            </div>
            <div style="padding: 20px; max-height: 500px; overflow-y: auto;">
                <div style="display: grid; gap: 12px;">
                    <div><strong>Navigation:</strong></div>
                    <div style="padding-left: 20px; display: grid; gap: 8px;">
                        <div><kbd>â†</kbd> <kbd>â†’</kbd> - Navigate images in lightbox</div>
                        <div><kbd>Esc</kbd> - Close modal or clear selection</div>
                    </div>
                    <div><strong>Lightbox:</strong></div>
                    <div style="padding-left: 20px; display: grid; gap: 8px;">
                        <div><kbd>+</kbd> <kbd>-</kbd> - Zoom in/out</div>
                        <div><kbd>0</kbd> - Reset zoom</div>
                        <div><kbd>I</kbd> - Toggle info panel</div>
                        <div>Mouse drag - Pan when zoomed</div>
                        <div>Mouse wheel - Zoom</div>
                    </div>
                    <div><strong>Selection:</strong></div>
                    <div style="padding-left: 20px; display: grid; gap: 8px;">
                        <div><kbd>Space</kbd> - Toggle selection mode</div>
                        <div><kbd>Ctrl/Cmd</kbd> + <kbd>A</kbd> - Select all</div>
                        <div><kbd>Shift</kbd> + <kbd>Click</kbd> - Range select</div>
                        <div><kbd>Ctrl/Cmd</kbd> + <kbd>Click</kbd> - Multi-select</div>
                    </div>
                    <div><strong>Actions:</strong></div>
                    <div style="padding-left: 20px; display: grid; gap: 8px;">
                        <div><kbd>F</kbd> - Toggle featured</div>
                        <div><kbd>D</kbd> - Download selected</div>
                        <div><kbd>Delete</kbd> - Delete selected</div>
                    </div>
                    <div><strong>Other:</strong></div>
                    <div style="padding-left: 20px; display: grid; gap: 8px;">
                        <div><kbd>?</kbd> - Show this help</div>
                        <div><kbd>Ctrl/Cmd</kbd> + <kbd>F</kbd> - Focus search</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates Modal -->
    <div id="templates-modal" class="modal" style="z-index: 2001;">
        <div class="modal-content" style="max-width: 800px; background: var(--bg-card); border-radius: 16px; padding: 0;">
            <div style="padding: 24px; border-bottom: 1px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; font-size: 24px; font-weight: 800; color: var(--text-primary);">Prompt Templates</h2>
                    <button onclick="toggleTemplatesModal()" style="
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        border: 1px solid var(--border);
                        background: rgba(255, 255, 255, 0.1);
                        color: var(--text-primary);
                        font-size: 24px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">&times;</button>
                </div>
            </div>
            <div style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <p style="margin: 0; color: var(--text-secondary);">Save and reuse your favorite prompts and settings</p>
                    <button onclick="showTemplateForm()" style="
                        padding: 10px 20px;
                        background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
                        border: none;
                        border-radius: 8px;
                        color: white;
                        cursor: pointer;
                        font-weight: 700;
                        box-shadow: 0 4px 12px var(--glow);
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    ">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        New Template
                    </button>
                </div>
                <div id="templates-list" style="display: grid; gap: 12px; max-height: 500px; overflow-y: auto;"></div>
                
                <!-- Template Form (hidden by default) -->
                <div id="template-form" style="display: none; margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid var(--border);">
                    <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 700; color: var(--text-primary);">Create Template</h3>
                    <input type="hidden" id="template-id" value="">
                    <div style="display: grid; gap: 16px;">
                        <div>
                            <label for="template-name" style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary);">Name</label>
                            <input type="text" id="template-name" placeholder="e.g., Portrait Photography" style="
                                width: 100%;
                                padding: 10px;
                                background: rgba(0,0,0,0.3);
                                border: 1px solid var(--border);
                                border-radius: 8px;
                                color: var(--text-primary);
                                font-size: 14px;
                            ">
                        </div>
                        <div>
                            <label for="template-prompt" style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary);">Prompt</label>
                            <textarea id="template-prompt" placeholder="Enter your prompt..." style="
                                width: 100%;
                                min-height: 100px;
                                padding: 10px;
                                background: rgba(0,0,0,0.3);
                                border: 1px solid var(--border);
                                border-radius: 8px;
                                color: var(--text-primary);
                                font-size: 14px;
                                resize: vertical;
                            "></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label for="template-width" style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary);">Width</label>
                                <input type="number" id="template-width" value="512" min="64" max="2048" step="64" style="
                                    width: 100%;
                                    padding: 10px;
                                    background: rgba(0,0,0,0.3);
                                    border: 1px solid var(--border);
                                    border-radius: 8px;
                                    color: var(--text-primary);
                                    font-size: 14px;
                                ">
                            </div>
                            <div>
                                <label for="template-height" style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary);">Height</label>
                                <input type="number" id="template-height" value="512" min="64" max="2048" step="64" style="
                                    width: 100%;
                                    padding: 10px;
                                    background: rgba(0,0,0,0.3);
                                    border: 1px solid var(--border);
                                    border-radius: 8px;
                                    color: var(--text-primary);
                                    font-size: 14px;
                                ">
                            </div>
                            <div>
                                <label for="template-steps" style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary);">Steps</label>
                                <input type="number" id="template-steps" value="20" min="1" max="150" style="
                                    width: 100%;
                                    padding: 10px;
                                    background: rgba(0,0,0,0.3);
                                    border: 1px solid var(--border);
                                    border-radius: 8px;
                                    color: var(--text-primary);
                                    font-size: 14px;
                                ">
                            </div>
                            <div>
                                <label for="template-guidance" style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary);">Guidance Scale</label>
                                <input type="number" id="template-guidance" value="7.5" min="1" max="30" step="0.5" style="
                                    width: 100%;
                                    padding: 10px;
                                    background: rgba(0,0,0,0.3);
                                    border: 1px solid var(--border);
                                    border-radius: 8px;
                                    color: var(--text-primary);
                                    font-size: 14px;
                                ">
                            </div>
                        </div>
                        <div>
                            <label for="template-tags" style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary);">Tags (comma separated)</label>
                            <input type="text" id="template-tags" placeholder="e.g., portrait, realistic, photography" style="
                                width: 100%;
                                padding: 10px;
                                background: rgba(0,0,0,0.3);
                                border: 1px solid var(--border);
                                border-radius: 8px;
                                color: var(--text-primary);
                                font-size: 14px;
                            ">
                        </div>
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="hideTemplateForm()" style="
                                padding: 10px 20px;
                                background: rgba(255,255,255,0.1);
                                border: 1px solid var(--border);
                                border-radius: 8px;
                                color: var(--text-primary);
                                cursor: pointer;
                                font-weight: 600;
                            ">Cancel</button>
                            <button onclick="saveTemplate()" style="
                                padding: 10px 20px;
                                background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
                                border: none;
                                border-radius: 8px;
                                color: white;
                                cursor: pointer;
                                font-weight: 700;
                                box-shadow: 0 4px 12px var(--glow);
                            ">Save Template</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Mode -->
    <div id="comparison-mode" class="comparison-mode">
        <div class="comparison-header">
            <h2 style="margin: 0; font-size: 24px; font-weight: 800; color: var(--text-primary);">Image Comparison</h2>
            <div class="comparison-controls">
                <button class="mode-toggle" id="side-by-side-btn" onclick="setComparisonMode('sideBySide')">
                    Side by Side
                </button>
                <button class="mode-toggle" id="slider-btn" onclick="setComparisonMode('slider')">
                    Slider
                </button>
                <button onclick="exitComparison()" style="
                    padding: 10px 20px;
                    background: rgba(255, 255, 255, 0.1);
                    border: 1px solid var(--border);
                    border-radius: 8px;
                    color: var(--text-primary);
                    cursor: pointer;
                    font-weight: 600;
                    margin-left: 12px;
                ">Close (Esc)</button>
            </div>
        </div>
        <div class="comparison-content" id="comparison-content">
            <!-- Side by side panels -->
            <div class="comparison-panel" id="comparison-left">
                <div class="comparison-image-container" id="compare-container-1">
                    <img id="compare-image-1" class="comparison-image" alt="Image 1">
                </div>
                <div class="comparison-metadata" id="compare-metadata-1"></div>
            </div>
            <div class="comparison-panel" id="comparison-right">
                <div class="comparison-image-container" id="compare-container-2">
                    <img id="compare-image-2" class="comparison-image" alt="Image 2">
                </div>
                <div class="comparison-metadata" id="compare-metadata-2"></div>
            </div>
        </div>
    </div>

    <!-- Bulk actions bar (shown when images are selected) -->
    <div id="bulk-actions-bar" style="
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg-card);
        border-top: 2px solid var(--accent);
        padding: 16px;
        display: none;
        justify-content: space-between;
        align-items: center;
        z-index: 1001;
        box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.6);
    ">
        <div style="display: flex; align-items: center; gap: 16px;">
            <span id="selection-count" style="font-weight: 700; color: var(--accent-light);"></span>
            <button onclick="clearSelection()" style="
                padding: 8px 16px;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid var(--border);
                border-radius: 8px;
                color: var(--text-primary);
                cursor: pointer;
                font-weight: 600;
            ">Clear Selection</button>
        </div>
        <div style="display: flex; gap: 12px;">
            <button onclick="bulkToggleFeatured()" style="
                padding: 10px 20px;
                background: linear-gradient(135deg, var(--accent-tertiary), #a855f7);
                border: none;
                border-radius: 10px;
                color: white;
                cursor: pointer;
                font-weight: 700;
                box-shadow: 0 4px 12px var(--glow-purple);
                display: flex;
                align-items: center;
                gap: 8px;
            ">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
                Toggle Featured
            </button>
            <button onclick="bulkDownload()" style="
                padding: 10px 20px;
                background: linear-gradient(135deg, var(--accent), #00b8d4);
                border: none;
                border-radius: 10px;
                color: white;
                cursor: pointer;
                font-weight: 700;
                box-shadow: 0 4px 12px var(--glow);
                display: flex;
                align-items: center;
                gap: 8px;
            ">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download All
            </button>
            <button onclick="bulkDelete()" style="
                padding: 10px 20px;
                background: linear-gradient(135deg, var(--accent-secondary), #ff4081);
                border: none;
                border-radius: 10px;
                color: white;
                cursor: pointer;
                font-weight: 700;
                box-shadow: 0 4px 12px var(--glow-pink);
                display: flex;
                align-items: center;
                gap: 8px;
            ">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
                Delete All
            </button>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
                Delete All
            </button>
        </div>
    </div>

    <script>
        let currentSearch = '';
        let currentSort = 'newest';
        let allImages = [];
        let selectedImages = new Set(); // Multi-select support
        let isSelectionMode = false;
        let lastSelectedIndex = -1;

        // Keyboard shortcuts modal
        function showShortcutsModal() {
            document.getElementById('shortcuts-modal').style.display = 'flex';
        }

        function closeShortcutsModal() {
            document.getElementById('shortcuts-modal').style.display = 'none';
        }

        // Template Management Functions
        let currentTemplates = [];

        function showTemplatesModal() {
            const modal = document.getElementById('templates-modal');
            modal.classList.add('active');
            loadTemplates();
        }

        function toggleTemplatesModal() {
            const modal = document.getElementById('templates-modal');
            if (modal.classList.contains('active')) {
                modal.classList.remove('active');
            } else {
                modal.classList.add('active');
                loadTemplates();
            }
        }

        async function loadTemplates() {
            try {
                const response = await fetch('/api/templates');
                currentTemplates = await response.json();
                renderTemplatesList();
            } catch (error) {
                console.error('Failed to load templates:', error);
                showToast('Failed to load templates', 'error');
            }
        }

        function renderTemplatesList() {
            const list = document.getElementById('templates-list');
            if (currentTemplates.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">No templates yet. Create your first template!</div>';
                return;
            }

            list.innerHTML = currentTemplates.map(template => `
                <div style="
                    background: rgba(255,255,255,0.05);
                    border: 1px solid var(--border);
                    border-radius: 12px;
                    padding: 16px;
                    display: flex;
                    gap: 16px;
                    align-items: start;
                    transition: all 0.3s ease;
                " onmouseenter="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='var(--accent)';" onmouseleave="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='var(--border)';">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 700; color: var(--text-primary);">${template.name}</h4>
                        <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 14px; line-height: 1.5;">${template.prompt.substring(0, 100)}${template.prompt.length > 100 ? '...' : ''}</p>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                            ${template.tags ? template.tags.map(tag => `<span style="
                                padding: 4px 10px;
                                background: rgba(88, 166, 255, 0.2);
                                border: 1px solid var(--accent);
                                border-radius: 6px;
                                font-size: 12px;
                                color: var(--accent-light);
                                font-weight: 600;
                            ">${tag}</span>`).join('') : ''}
                        </div>
                        <div style="display: flex; gap: 16px; font-size: 12px; color: var(--text-secondary);">
                            <span>ðŸ“ ${template.width}Ã—${template.height}</span>
                            <span>ðŸŽ¯ ${template.num_inference_steps} steps</span>
                            <span>âš–ï¸ ${template.guidance_scale} guidance</span>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button onclick="applyTemplate('${template.id}')" style="
                            padding: 8px 16px;
                            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
                            border: none;
                            border-radius: 8px;
                            color: white;
                            cursor: pointer;
                            font-weight: 700;
                            font-size: 12px;
                            white-space: nowrap;
                            box-shadow: 0 2px 8px var(--glow);
                        ">Apply</button>
                        <button onclick="editTemplate('${template.id}')" style="
                            padding: 8px 16px;
                            background: rgba(255,255,255,0.1);
                            border: 1px solid var(--border);
                            border-radius: 8px;
                            color: var(--text-primary);
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 12px;
                            white-space: nowrap;
                        ">Edit</button>
                        <button onclick="deleteTemplate('${template.id}')" style="
                            padding: 8px 16px;
                            background: rgba(248, 81, 73, 0.2);
                            border: 1px solid var(--danger);
                            border-radius: 8px;
                            color: var(--danger);
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 12px;
                            white-space: nowrap;
                        ">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function showTemplateForm(templateId = null) {
            const form = document.getElementById('template-form');
            const formTitle = form.querySelector('h3');
            
            if (templateId) {
                const template = currentTemplates.find(t => t.id === templateId);
                if (template) {
                    formTitle.textContent = 'Edit Template';
                    document.getElementById('template-id').value = template.id;
                    document.getElementById('template-name').value = template.name;
                    document.getElementById('template-prompt').value = template.prompt;
                    document.getElementById('template-width').value = template.width;
                    document.getElementById('template-height').value = template.height;
                    document.getElementById('template-steps').value = template.num_inference_steps;
                    document.getElementById('template-guidance').value = template.guidance_scale;
                    document.getElementById('template-tags').value = template.tags ? template.tags.join(', ') : '';
                }
            } else {
                formTitle.textContent = 'Create Template';
                document.getElementById('template-id').value = '';
                document.getElementById('template-name').value = '';
                document.getElementById('template-prompt').value = '';
                document.getElementById('template-width').value = '512';
                document.getElementById('template-height').value = '512';
                document.getElementById('template-steps').value = '20';
                document.getElementById('template-guidance').value = '7.5';
                document.getElementById('template-tags').value = '';
            }
            
            form.style.display = 'block';
            document.getElementById('templates-list').style.display = 'none';
        }

        function hideTemplateForm() {
            document.getElementById('template-form').style.display = 'none';
            document.getElementById('templates-list').style.display = 'grid';
        }

        async function saveTemplate() {
            const templateId = document.getElementById('template-id').value;
            const name = document.getElementById('template-name').value.trim();
            const prompt = document.getElementById('template-prompt').value.trim();
            const width = parseInt(document.getElementById('template-width').value);
            const height = parseInt(document.getElementById('template-height').value);
            const num_inference_steps = parseInt(document.getElementById('template-steps').value);
            const guidance_scale = parseFloat(document.getElementById('template-guidance').value);
            const tagsText = document.getElementById('template-tags').value.trim();
            const tags = tagsText ? tagsText.split(',').map(t => t.trim()).filter(t => t) : [];

            if (!name || !prompt) {
                showToast('Name and prompt are required', 'error');
                return;
            }

            try {
                const url = templateId ? `/api/templates/${templateId}` : '/api/templates';
                const method = templateId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, prompt, width, height, num_inference_steps, guidance_scale, tags })
                });

                if (response.ok) {
                    showToast(templateId ? 'Template updated!' : 'Template created!', 'success');
                    hideTemplateForm();
                    await loadTemplates();
                } else {
                    showToast('Failed to save template', 'error');
                }
            } catch (error) {
                console.error('Failed to save template:', error);
                showToast('Failed to save template', 'error');
            }
        }

        function editTemplate(templateId) {
            showTemplateForm(templateId);
        }

        async function deleteTemplate(templateId) {
            if (!confirm('Are you sure you want to delete this template?')) {
                return;
            }

            try {
                const response = await fetch(`/api/templates/${templateId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('Template deleted!', 'success');
                    await loadTemplates();
                } else {
                    showToast('Failed to delete template', 'error');
                }
            } catch (error) {
                console.error('Failed to delete template:', error);
                showToast('Failed to delete template', 'error');
            }
        }

        function applyTemplate(templateId) {
            const template = currentTemplates.find(t => t.id === templateId);
            if (!template) return;

            // Close templates modal first
            toggleTemplatesModal();

            // Show detailed template modal
            const detailModal = document.createElement('div');
            detailModal.id = 'template-detail-modal';
            detailModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.9);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: var(--bg-card);
                border: 2px solid var(--accent);
                border-radius: 16px;
                padding: 32px;
                max-width: 700px;
                width: 100%;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            // Build modal HTML
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px;">
                    <h2 style="margin: 0; font-size: 24px; font-weight: 800; color: var(--text-primary);">${template.name}</h2>
                    <button id="close-detail-modal" style="
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        border: 1px solid var(--border);
                        background: rgba(255, 255, 255, 0.1);
                        color: var(--text-primary);
                        font-size: 24px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">&times;</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label style="font-weight: 700; color: var(--text-primary);">Prompt:</label>
                        <button id="copy-prompt-btn" style="
                            padding: 6px 12px;
                            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
                            border: none;
                            border-radius: 6px;
                            color: white;
                            cursor: pointer;
                            font-size: 12px;
                            font-weight: 600;
                        ">Copy</button>
                    </div>
                    <div style="
                        padding: 12px;
                        background: rgba(0, 0, 0, 0.4);
                        border: 1px solid var(--border);
                        border-radius: 8px;
                        color: var(--text-secondary);
                        font-size: 14px;
                        line-height: 1.6;
                        word-wrap: break-word;
                    ">${template.prompt}</div>
                </div>
            `;
            
            if (template.negative_prompt) {
                html += `
                <div style="margin-bottom: 20px;">
                    <label style="font-weight: 700; color: var(--text-primary); display: block; margin-bottom: 8px;">Negative Prompt:</label>
                    <div style="
                        padding: 12px;
                        background: rgba(0, 0, 0, 0.4);
                        border: 1px solid var(--border);
                        border-radius: 8px;
                        color: var(--text-secondary);
                        font-size: 14px;
                        line-height: 1.6;
                        word-wrap: break-word;
                    ">${template.negative_prompt}</div>
                </div>
                `;
            }
            
            html += `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px;">
                    <div style="
                        padding: 12px;
                        background: rgba(88, 166, 255, 0.1);
                        border: 1px solid var(--accent);
                        border-radius: 8px;
                    ">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Dimensions</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--accent-light);">${template.width} Ã— ${template.height}</div>
                    </div>
                    <div style="
                        padding: 12px;
                        background: rgba(88, 166, 255, 0.1);
                        border: 1px solid var(--accent);
                        border-radius: 8px;
                    ">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Steps</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--accent-light);">${template.num_inference_steps}</div>
                    </div>
                    <div style="
                        padding: 12px;
                        background: rgba(88, 166, 255, 0.1);
                        border: 1px solid var(--accent);
                        border-radius: 8px;
                    ">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Guidance Scale</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--accent-light);">${template.guidance_scale}</div>
                    </div>
                    <div style="
                        padding: 12px;
                        background: rgba(88, 166, 255, 0.1);
                        border: 1px solid var(--accent);
                        border-radius: 8px;
                    ">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Tags</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--accent-light);">${template.tags ? template.tags.length : 0}</div>
                    </div>
                </div>
            `;
            
            if (template.tags && template.tags.length > 0) {
                html += `
                <div style="margin-bottom: 20px;">
                    <label style="font-weight: 700; color: var(--text-primary); display: block; margin-bottom: 8px;">Tags:</label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        ${template.tags.map(tag => `<span style="
                            padding: 6px 12px;
                            background: rgba(88, 166, 255, 0.2);
                            border: 1px solid var(--accent);
                            border-radius: 6px;
                            font-size: 12px;
                            color: var(--accent-light);
                            font-weight: 600;
                        ">${tag}</span>`).join('')}
                    </div>
                </div>
                `;
            }
            
            html += `
                <button id="copy-json-btn" style="
                    width: 100%;
                    padding: 14px;
                    background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
                    border: none;
                    border-radius: 10px;
                    color: white;
                    cursor: pointer;
                    font-weight: 700;
                    font-size: 16px;
                    box-shadow: 0 4px 12px var(--glow);
                ">Copy All Settings as JSON</button>
            `;
            
            modalContent.innerHTML = html;
            detailModal.appendChild(modalContent);
            document.body.appendChild(detailModal);
            
            // Add event listeners
            document.getElementById('close-detail-modal').onclick = () => detailModal.remove();
            document.getElementById('copy-prompt-btn').onclick = () => {
                navigator.clipboard.writeText(template.prompt).then(() => {
                    showToast('Prompt copied to clipboard!', 'success');
                });
            };
            document.getElementById('copy-json-btn').onclick = () => {
                const json = JSON.stringify(template, null, 2);
                navigator.clipboard.writeText(json).then(() => {
                    showToast('Template data copied to clipboard!', 'success');
                });
            };
            detailModal.onclick = (e) => {
                if (e.target === detailModal) detailModal.remove();
            };
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 80px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--accent)' : 'var(--bg-card)'};
                color: white;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.4);
                z-index: 10000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Image Comparison Mode
        let comparisonImage1 = null;
        let comparisonImage2 = null;
        let comparisonMode = 'sideBySide';
        let sliderPosition = 50;

        function startComparison() {
            if (currentImageIndex === null || !filteredImages.length) {
                showToast('Open an image first to start comparison', 'error');
                return;
            }

            // Set first image as the currently opened image
            comparisonImage1 = filteredImages[currentImageIndex];
            
            // Prompt user to select second image
            showToast('Click another image in the gallery to compare', 'info');
            
            // Close modal and enable comparison selection mode
            document.getElementById('modal').style.display = 'none';
            document.body.style.cursor = 'crosshair';
            
            // Add click handler to gallery items
            const galleryItems = document.querySelectorAll('.gallery-item');
            galleryItems.forEach((item, index) => {
                item.style.outline = '2px dashed var(--accent)';
                item.style.cursor = 'crosshair';
                const originalClick = item.onclick;
                item.onclick = (e) => {
                    e.stopPropagation();
                    selectComparisonImage(index);
                };
            });
        }

        function selectComparisonImage(index) {
            // Set second image
            comparisonImage2 = filteredImages[index];
            
            // Remove selection handlers and restore normal gallery behavior
            const galleryItems = document.querySelectorAll('.gallery-item');
            galleryItems.forEach((item, idx) => {
                item.style.outline = 'none';
                item.style.cursor = 'pointer';
                item.onclick = () => openModal(idx);
            });
            document.body.style.cursor = 'default';
            
            // Show comparison mode
            showComparisonMode();
        }

        function showComparisonMode() {
            const modal = document.getElementById('comparison-mode');
            modal.style.display = 'block';
            
            // Load images
            document.getElementById('compare-image-1').src = comparisonImage1.full_url;
            document.getElementById('compare-image-2').src = comparisonImage2.full_url;
            
            // Set initial mode
            setComparisonMode('sideBySide');
            
            // Render metadata
            renderComparisonMetadata();
        }

        function setComparisonMode(mode) {
            comparisonMode = mode;
            const content = document.getElementById('comparison-content');
            const leftPanel = document.getElementById('comparison-left');
            const rightPanel = document.getElementById('comparison-right');
            const sideBySideBtn = document.getElementById('side-by-side-btn');
            const sliderBtn = document.getElementById('slider-btn');
            
            // Update button states
            sideBySideBtn.classList.toggle('active', mode === 'sideBySide');
            sliderBtn.classList.toggle('active', mode === 'slider');
            
            if (mode === 'sideBySide') {
                // Side by side layout
                leftPanel.style.display = 'flex';
                rightPanel.style.display = 'flex';
                leftPanel.classList.remove('slider-mode');
                rightPanel.classList.remove('slider-mode');
                
                // Remove slider if exists
                const existingSlider = content.querySelector('.comparison-slider');
                if (existingSlider) existingSlider.remove();
                
            } else if (mode === 'slider') {
                // Slider overlay layout
                leftPanel.classList.add('slider-mode');
                rightPanel.classList.add('slider-mode');
                leftPanel.style.display = 'block';
                rightPanel.style.display = 'block';
                
                // Create slider
                if (!content.querySelector('.comparison-slider')) {
                    const slider = document.createElement('div');
                    slider.className = 'comparison-slider';
                    slider.style.left = sliderPosition + '%';
                    content.appendChild(slider);
                    
                    // Add slider drag functionality
                    let isDragging = false;
                    slider.addEventListener('mousedown', () => isDragging = true);
                    document.addEventListener('mouseup', () => isDragging = false);
                    content.addEventListener('mousemove', (e) => {
                        if (isDragging) {
                            const rect = content.getBoundingClientRect();
                            const x = e.clientX - rect.left;
                            sliderPosition = (x / rect.width) * 100;
                            sliderPosition = Math.max(0, Math.min(100, sliderPosition));
                            slider.style.left = sliderPosition + '%';
                            rightPanel.style.clipPath = `inset(0 0 0 ${sliderPosition}%)`;
                        }
                    });
                }
                
                // Apply clip path
                rightPanel.style.clipPath = `inset(0 0 0 ${sliderPosition}%)`;
            }
        }

        function renderComparisonMetadata() {
            const meta1 = comparisonImage1.metadata || {};
            const meta2 = comparisonImage2.metadata || {};
            
            // Create diff table
            const fields = ['prompt', 'negative_prompt', 'width', 'height', 'num_inference_steps', 'guidance_scale', 'seed'];
            const labels = {
                prompt: 'Prompt',
                negative_prompt: 'Negative Prompt',
                width: 'Width',
                height: 'Height',
                num_inference_steps: 'Steps',
                guidance_scale: 'Guidance',
                seed: 'Seed'
            };
            
            let tableHTML = '<table class="comparison-diff-table"><thead><tr><th>Property</th><th>Image 1</th><th>Image 2</th></tr></thead><tbody>';
            
            fields.forEach(field => {
                const val1 = meta1[field] || 'N/A';
                const val2 = meta2[field] || 'N/A';
                const isDiff = val1 !== val2;
                const diffClass = isDiff ? ' class="diff"' : '';
                
                let displayVal1 = val1;
                let displayVal2 = val2;
                
                // Truncate long prompts
                if (field === 'prompt' || field === 'negative_prompt') {
                    displayVal1 = String(val1).substring(0, 50) + (String(val1).length > 50 ? '...' : '');
                    displayVal2 = String(val2).substring(0, 50) + (String(val2).length > 50 ? '...' : '');
                }
                
                tableHTML += `<tr><td>${labels[field]}</td><td${diffClass}>${displayVal1}</td><td${diffClass}>${displayVal2}</td></tr>`;
            });
            
            tableHTML += '</tbody></table>';
            
            // Show in both panels
            document.getElementById('compare-metadata-1').innerHTML = tableHTML;
            document.getElementById('compare-metadata-2').innerHTML = tableHTML;
        }

        function exitComparison() {
            document.getElementById('comparison-mode').style.display = 'none';
            comparisonImage1 = null;
            comparisonImage2 = null;
            sliderPosition = 50;
        }

        // Selection management
        function toggleSelection(index) {
            if (selectedImages.has(index)) {
                selectedImages.delete(index);
            } else {
                selectedImages.add(index);
            }
            updateSelectionUI();
        }

        function selectRange(fromIndex, toIndex) {
            const start = Math.min(fromIndex, toIndex);
            const end = Math.max(fromIndex, toIndex);
            for (let i = start; i <= end; i++) {
                selectedImages.add(i);
            }
            updateSelectionUI();
        }

        function selectAll() {
            selectedImages.clear();
            for (let i = 0; i < allImages.length; i++) {
                selectedImages.add(i);
            }
            updateSelectionUI();
        }

        function clearSelection() {
            selectedImages.clear();
            isSelectionMode = false;
            lastSelectedIndex = -1;
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const bulkBar = document.getElementById('bulk-actions-bar');
            const selectionCount = document.getElementById('selection-count');
            
            if (selectedImages.size > 0) {
                bulkBar.style.display = 'flex';
                selectionCount.textContent = `${selectedImages.size} image${selectedImages.size > 1 ? 's' : ''} selected`;
            } else {
                bulkBar.style.display = 'none';
            }
            
            // Update visual indicators
            renderGallery();
        }

        // Bulk actions
        async function bulkToggleFeatured() {
            if (selectedImages.size === 0) return;
            
            let successCount = 0;
            for (const index of selectedImages) {
                const image = allImages[index];
                try {
                    const newFeatured = !image.featured;
                    await fetch(`/api/images/${image.path}/featured?featured=${newFeatured}`, { method: 'PUT' });
                    successCount++;
                } catch (error) {
                    console.error(`Failed to toggle featured for ${image.path}:`, error);
                }
            }
            
            showToast(`Updated ${successCount} image(s)`, 'success');
            clearSelection();
            await loadImages();
            await loadStats();
        }

        async function bulkDownload() {
            if (selectedImages.size === 0) return;
            
            showToast('Preparing download...', 'info');
            
            // Download each image individually
            for (const index of selectedImages) {
                const image = allImages[index];
                try {
                    const response = await fetch(`/api/images/file/${image.path}`);
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = image.filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // Small delay between downloads to avoid browser blocking
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (error) {
                    console.error(`Failed to download ${image.filename}:`, error);
                }
            }
            
            showToast(`Downloaded ${selectedImages.size} image(s)`, 'success');
            clearSelection();
        }

        async function bulkDelete() {
            if (selectedImages.size === 0) return;
            
            if (!confirm(`Are you sure you want to delete ${selectedImages.size} image(s)? This cannot be undone.`)) {
                return;
            }
            
            let successCount = 0;
            for (const index of selectedImages) {
                const image = allImages[index];
                try {
                    await fetch(`/api/images/${image.path}`, { method: 'DELETE' });
                    successCount++;
                } catch (error) {
                    console.error(`Failed to delete ${image.path}:`, error);
                }
            }
            
            showToast(`Deleted ${successCount} image(s)`, 'success');
            clearSelection();
            await loadImages();
            await loadStats();
        }

        // Global keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ignore if typing in input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            // ? - Show shortcuts help
            if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                showShortcutsModal();
                return;
            }
            
            // Escape - Close modal or clear selection
            if (e.key === 'Escape') {
                const modal = document.getElementById('modal');
                const shortcutsModal = document.getElementById('shortcuts-modal');
                const comparisonModal = document.getElementById('comparison-mode');
                
                if (comparisonModal.style.display === 'block') {
                    exitComparison();
                } else if (modal.classList.contains('active')) {
                    closeModal();
                } else if (shortcutsModal.style.display === 'flex') {
                    closeShortcutsModal();
                } else if (selectedImages.size > 0) {
                    clearSelection();
                }
                return;
            }
            
            // Arrow keys - Navigate modal if open
            const modal = document.getElementById('modal');
            if (modal.classList.contains('active')) {
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    navigateModal(-1);
                    return;
                }
                if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    navigateModal(1);
                    return;
                }
                if (e.key === '+' || e.key === '=') {
                    e.preventDefault();
                    zoomModal(0.2);
                    return;
                }
                if (e.key === '-' || e.key === '_') {
                    e.preventDefault();
                    zoomModal(-0.2);
                    return;
                }
                if (e.key === '0') {
                    e.preventDefault();
                    resetZoom();
                    return;
                }
                if (e.key === 'i' || e.key === 'I') {
                    e.preventDefault();
                    toggleModalInfo();
                    return;
                }
                if (e.key === 'c' || e.key === 'C') {
                    e.preventDefault();
                    startComparison();
                    return;
                }
                // Don't process other shortcuts when modal is open
                return;
            }
            
            // Ctrl/Cmd + A - Select all
            if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                e.preventDefault();
                selectAll();
                return;
            }
            
            // Ctrl/Cmd + F - Focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById('search').focus();
                return;
            }
            
            // Space - Toggle selection mode
            if (e.key === ' ' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                isSelectionMode = !isSelectionMode;
                if (!isSelectionMode) {
                    clearSelection();
                }
                showToast(isSelectionMode ? 'Selection mode ON - Click images to select' : 'Selection mode OFF', 'info');
                return;
            }
            
            // F - Toggle featured for selected or first
            if (e.key === 'f' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                if (selectedImages.size > 0) {
                    bulkToggleFeatured();
                } else if (allImages.length > 0) {
                    toggleFeatured(allImages[0].path, allImages[0].featured, { stopPropagation: () => {} });
                }
                return;
            }
            
            // D - Download selected
            if (e.key === 'd' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                if (selectedImages.size > 0) {
                    bulkDownload();
                }
                return;
            }
            
            // Delete - Delete selected
            if (e.key === 'Delete') {
                e.preventDefault();
                if (selectedImages.size > 0) {
                    bulkDelete();
                }
                return;
            }
        });

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                document.getElementById('total-images').textContent = stats.total_images;
                document.getElementById('total-prompts').textContent = stats.total_prompts;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load all images
        async function loadImages() {
            const params = new URLSearchParams({ limit: 500 });
            if (currentSearch) params.append('search', currentSearch);

            try {
                const response = await fetch(`/api/images?${params}`);
                allImages = await response.json();
                sortImages();
                renderGallery();
            } catch (error) {
                console.error('Failed to load images:', error);
                document.getElementById('gallery').innerHTML = 
                    '<div class="empty-state"><div class="empty-icon">ðŸ˜”</div><h2>Failed to load gallery</h2><p>Please refresh the page</p></div>';
            }
        }

        // Sort images
        function sortImages() {
            if (currentSort === 'newest') {
                allImages.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            } else if (currentSort === 'oldest') {
                allImages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            } else if (currentSort === 'prompt') {
                allImages.sort((a, b) => a.prompt.localeCompare(b.prompt));
            }
        }

        // Advanced Filters
        let currentFilters = {
            dateFrom: null,
            dateTo: null,
            lora: null,
            dimensions: null,
            featured: null
        };

        function toggleAdvancedFilters() {
            const panel = document.getElementById('advanced-filters');
            const btn = document.querySelector('.filter-toggle-btn');
            
            if (panel.style.display === 'none' || !panel.style.display) {
                panel.style.display = 'flex';
                btn.classList.add('active');
            } else {
                panel.style.display = 'none';
                btn.classList.remove('active');
            }
        }

        function applyFilters() {
            // Get filter values
            currentFilters.dateFrom = document.getElementById('filter-date-from').value || null;
            currentFilters.dateTo = document.getElementById('filter-date-to').value || null;
            currentFilters.lora = document.getElementById('filter-lora').value || null;
            currentFilters.dimensions = document.getElementById('filter-dimensions').value || null;
            currentFilters.featured = document.getElementById('filter-featured').value || null;

            renderGallery();
            updateFilterCount();
        }

        function clearFilters() {
            // Reset filter values
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-lora').value = '';
            document.getElementById('filter-dimensions').value = '';
            document.getElementById('filter-featured').value = '';

            currentFilters = {
                dateFrom: null,
                dateTo: null,
                lora: null,
                dimensions: null,
                featured: null
            };

            renderGallery();
            updateFilterCount();
            showToast('Filters cleared', 'success');
        }

        function filterImages(images) {
            return images.filter(image => {
                // Date range filter
                if (currentFilters.dateFrom) {
                    const imageDate = new Date(image.created_at).toISOString().split('T')[0];
                    if (imageDate < currentFilters.dateFrom) return false;
                }
                if (currentFilters.dateTo) {
                    const imageDate = new Date(image.created_at).toISOString().split('T')[0];
                    if (imageDate > currentFilters.dateTo) return false;
                }

                // LoRA model filter
                if (currentFilters.lora && image.lora_name !== currentFilters.lora) {
                    return false;
                }

                // Dimensions filter
                if (currentFilters.dimensions) {
                    const [width, height] = currentFilters.dimensions.split('x');
                    if (image.width != width || image.height != height) {
                        return false;
                    }
                }

                // Featured filter
                if (currentFilters.featured !== null && currentFilters.featured !== '') {
                    const isFeatured = currentFilters.featured === 'true';
                    if (image.featured !== isFeatured) {
                        return false;
                    }
                }

                return true;
            });
        }

        function updateFilterCount() {
            const activeFilters = Object.values(currentFilters).filter(v => v !== null).length;
            const countEl = document.getElementById('filter-count');
            
            if (activeFilters > 0) {
                countEl.textContent = `${activeFilters} filter${activeFilters > 1 ? 's' : ''} active`;
                countEl.style.color = 'var(--accent)';
            } else {
                countEl.textContent = '';
            }
        }

        function populateLoRAFilter() {
            const loraSelect = document.getElementById('filter-lora');
            const loraModels = [...new Set(allImages.map(img => img.lora_name).filter(Boolean))];
            
            loraModels.forEach(lora => {
                const option = document.createElement('option');
                option.value = lora;
                option.textContent = lora;
                loraSelect.appendChild(option);
            });
        }

        // Toggle featured
        async function toggleFeatured(imagePath, currentFeatured, event) {
            event.stopPropagation();
            
            const newFeatured = !currentFeatured;
            
            try {
                const response = await fetch(`/api/images/${imagePath}/featured?featured=${newFeatured}`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    showToast(newFeatured ? 'â­ Added to featured!' : 'Removed from featured', 'success');
                    loadImages();
                    loadStats();
                } else {
                    throw new Error('Failed to update featured status');
                }
            } catch (error) {
                console.error('Failed to toggle featured:', error);
                showToast('Failed to update featured status', 'error');
            }
        }

        // Delete image
        async function deleteImage(imagePath, event) {
            event.stopPropagation();
            
            if (!confirm('Are you sure you want to delete this image? This cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/images/${imagePath}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast('ðŸ—‘ï¸ Image deleted successfully', 'success');
                    loadImages();
                    loadStats();
                } else {
                    throw new Error('Failed to delete image');
                }
            } catch (error) {
                console.error('Failed to delete image:', error);
                showToast('Failed to delete image', 'error');
            }
        }

        // Download image
        function downloadImage(imagePath, filename, event) {
            event.stopPropagation();
            
            const link = document.createElement('a');
            link.href = `/api/images/file/${imagePath}`;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('â¬‡ï¸ Download started', 'success');
        }

        // Render gallery
        function renderGallery() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';

            // Apply filters
            const filteredImages = filterImages(allImages);

            if (filteredImages.length === 0) {
                gallery.innerHTML = 
                    '<div class="empty-state"><div class="empty-icon">ðŸŽ¨</div><h2>No artworks found</h2><p>Try adjusting your search or filters!</p></div>';
                return;
            }

            filteredImages.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                
                // Add selection highlight if selected
                const originalIndex = allImages.indexOf(image);
                if (selectedImages.has(originalIndex)) {
                    item.style.outline = '3px solid var(--accent)';
                    item.style.outlineOffset = '-3px';
                }
                
                // Handle click with selection support
                item.onclick = (e) => {
                    if (isSelectionMode || e.shiftKey || e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        
                        if (e.shiftKey && lastSelectedIndex !== -1) {
                            // Range select
                            selectRange(lastSelectedIndex, originalIndex);
                        } else if (e.ctrlKey || e.metaKey) {
                            // Multi-select
                            toggleSelection(originalIndex);
                        } else {
                            // Single toggle
                            toggleSelection(originalIndex);
                        }
                        
                        lastSelectedIndex = index;
                    } else {
                        openModal(image, index);
                    }
                };

                const imageContainer = document.createElement('div');
                imageContainer.className = 'gallery-item-image-container';

                // Selection checkbox overlay
                if (selectedImages.has(index) || isSelectionMode) {
                    const checkbox = document.createElement('div');
                    checkbox.style.cssText = `
                        position: absolute;
                        top: 8px;
                        left: 8px;
                        width: 24px;
                        height: 24px;
                        background: ${selectedImages.has(index) ? 'var(--accent)' : 'rgba(0, 0, 0, 0.5)'};
                        border: 2px solid white;
                        border-radius: 4px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10;
                        cursor: pointer;
                    `;
                    checkbox.innerHTML = selectedImages.has(index) ? 'âœ“' : '';
                    checkbox.style.color = 'white';
                    checkbox.style.fontWeight = 'bold';
                    imageContainer.appendChild(checkbox);
                }

                // Featured badge
                if (image.featured) {
                    const badge = document.createElement('div');
                    badge.className = 'featured-badge';
                    badge.innerHTML = 'â­ Featured';
                    imageContainer.appendChild(badge);
                }

                // Action buttons
                const actions = document.createElement('div');
                actions.className = 'gallery-item-actions';

                const featuredBtn = document.createElement('button');
                featuredBtn.className = image.featured ? 'action-btn featured' : 'action-btn';
                featuredBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>';
                featuredBtn.title = image.featured ? 'Remove from featured' : 'Add to featured';
                featuredBtn.onclick = (e) => toggleFeatured(image.path, image.featured, e);

                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'action-btn download';
                downloadBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>';
                downloadBtn.title = 'Download';
                downloadBtn.onclick = (e) => downloadImage(image.path, image.filename, e);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'action-btn delete';
                deleteBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>';
                deleteBtn.title = 'Delete';
                deleteBtn.onclick = (e) => deleteImage(image.path, e);

                actions.appendChild(featuredBtn);
                actions.appendChild(downloadBtn);
                actions.appendChild(deleteBtn);
                imageContainer.appendChild(actions);

                const img = document.createElement('img');
                img.src = `/api/images/file/${image.path}`;
                img.alt = image.prompt;
                img.loading = 'lazy';

                imageContainer.appendChild(img);

                const info = document.createElement('div');
                info.className = 'gallery-item-info';

                const prompt = document.createElement('div');
                prompt.className = 'gallery-item-prompt';
                prompt.textContent = image.prompt;

                const meta = document.createElement('div');
                meta.className = 'gallery-item-meta';

                const date = document.createElement('span');
                date.textContent = new Date(image.created_at).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });

                meta.appendChild(date);
                info.appendChild(prompt);
                info.appendChild(meta);
                item.appendChild(imageContainer);
                item.appendChild(info);
                gallery.appendChild(item);
            });

            // Update masonry layout if active
            if (gallery.classList.contains('masonry')) {
                setTimeout(updateMasonryLayout, 300);
            }
        }

        // Modal functions
        let currentModalIndex = 0;
        let modalZoom = 1;
        let modalPanX = 0;
        let modalPanY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let isModalInfoVisible = true;

        function openModal(image, index = null) {
            const modal = document.getElementById('modal');
            const modalInfo = document.getElementById('modal-info');
            const modalInfoToggle = document.getElementById('modal-info-toggle');
            
            // Find image index if not provided
            if (index === null) {
                currentModalIndex = allImages.findIndex(img => img.path === image.path);
            } else {
                currentModalIndex = index;
            }
            
            updateModalContent();
            modal.classList.add('active');
            
            // Show info sidebar by default
            modalInfo.classList.add('visible');
            modalInfoToggle.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
            isModalInfoVisible = true;
            
            document.body.style.overflow = 'hidden';
            resetZoom();
        }

        function updateModalContent() {
            const image = allImages[currentModalIndex];
            const modalImage = document.getElementById('modal-image');
            const modalInfoContent = document.getElementById('modal-info-content');
            const modalActions = document.getElementById('modal-actions');
            const modalCounter = document.getElementById('modal-counter');
            const modalPrev = document.getElementById('modal-prev');
            const modalNext = document.getElementById('modal-next');

            const imagePath = `/api/images/file/${image.path}`;
            modalImage.src = imagePath;

            // Update counter
            modalCounter.textContent = `${currentModalIndex + 1} of ${allImages.length}`;

            // Update navigation buttons
            modalPrev.disabled = currentModalIndex === 0;
            modalNext.disabled = currentModalIndex === allImages.length - 1;

            // Create action buttons
            modalActions.innerHTML = `
                <button class="modal-btn" onclick="toggleFeaturedInModal(event)" style="width: 100%;">
                    <span>${image.featured ? 'â­' : 'â˜†'}</span> ${image.featured ? 'Unfeature' : 'Feature'}
                </button>
                <a class="modal-btn" href="${imagePath}" download="${image.filename}" style="width: 100%;">
                    <span>â¬‡</span> Download
                </a>
                <button class="modal-btn" onclick="deleteImageFromModal(event)" style="width: 100%; background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: #ef4444;">
                    <span>ðŸ—‘</span> Delete
                </button>
            `;

            modalInfoContent.innerHTML = `
                <h3>${image.prompt}</h3>
                ${image.featured ? '<p><strong>Status:</strong> â­ Featured</p>' : ''}
                <p><strong>Created:</strong> ${new Date(image.created_at).toLocaleString('en-US', {
                    dateStyle: 'full',
                    timeStyle: 'short'
                })}</p>
                <p><strong>File:</strong> ${image.filename}</p>
                ${image.metadata && Object.keys(image.metadata).length > 0 ? `
                    <p><strong>Dimensions:</strong> ${image.metadata.width || 'N/A'} Ã— ${image.metadata.height || 'N/A'}</p>
                    ${image.metadata.model ? `<p><strong>Model:</strong> ${image.metadata.model}</p>` : ''}
                    ${image.metadata.seed ? `<p><strong>Seed:</strong> ${image.metadata.seed}</p>` : ''}
                    ${image.metadata.steps ? `<p><strong>Steps:</strong> ${image.metadata.steps}</p>` : ''}
                    ${image.metadata.guidance_scale ? `<p><strong>Guidance:</strong> ${image.metadata.guidance_scale}</p>` : ''}
                ` : ''}
            `;
        }

        function navigateModal(direction) {
            const newIndex = currentModalIndex + direction;
            if (newIndex >= 0 && newIndex < allImages.length) {
                currentModalIndex = newIndex;
                updateModalContent();
                resetZoom();
            }
        }

        function toggleModalInfo() {
            const modalInfo = document.getElementById('modal-info');
            const modalInfoToggle = document.getElementById('modal-info-toggle');
            isModalInfoVisible = !isModalInfoVisible;
            
            if (isModalInfoVisible) {
                modalInfo.classList.add('visible');
                modalInfoToggle.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
            } else {
                modalInfo.classList.remove('visible');
                modalInfoToggle.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
            }
        }

        function zoomModal(delta) {
            modalZoom += delta;
            modalZoom = Math.max(0.5, Math.min(modalZoom, 3)); // Limit zoom between 50% and 300%
            applyZoom();
        }

        function resetZoom() {
            modalZoom = 1;
            modalPanX = 0;
            modalPanY = 0;
            applyZoom();
        }

        function applyZoom() {
            const modalImage = document.getElementById('modal-image');
            const zoomLevel = document.getElementById('modal-zoom-level');
            modalImage.style.transform = `scale(${modalZoom}) translate(${modalPanX}px, ${modalPanY}px)`;
            zoomLevel.textContent = `${Math.round(modalZoom * 100)}%`;
        }

        // Pan with mouse drag
        const modalImageContainer = document.getElementById('modal-image-container');
        modalImageContainer.addEventListener('mousedown', (e) => {
            if (modalZoom > 1) {
                isDragging = true;
                dragStartX = e.clientX - modalPanX;
                dragStartY = e.clientY - modalPanY;
                modalImageContainer.style.cursor = 'grabbing';
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                modalPanX = e.clientX - dragStartX;
                modalPanY = e.clientY - dragStartY;
                applyZoom();
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            modalImageContainer.style.cursor = 'move';
        });

        // Zoom with mouse wheel
        modalImageContainer.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            zoomModal(delta);
        });

        function toggleFeaturedInModal(event) {
            const image = allImages[currentModalIndex];
            toggleFeatured(image.path, image.featured, event);
            // Update modal content after a short delay to allow API call to complete
            setTimeout(() => {
                const updatedImage = allImages[currentModalIndex];
                updateModalContent();
            }, 500);
        }

        function deleteImageFromModal(event) {
            const image = allImages[currentModalIndex];
            if (confirm('Are you sure you want to delete this image? This cannot be undone.')) {
                deleteImage(image.path, event);
                closeModal();
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            document.body.style.overflow = '';
            resetZoom();
        }

        // Event listeners
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeModal();
        });

        // Search input
        let searchTimeout;
        document.getElementById('search').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearch = e.target.value;
                loadImages();
            }, 500);
        });

        // Sort select
        document.getElementById('sort-select').addEventListener('change', (e) => {
            currentSort = e.target.value;
            sortImages();
            renderGallery();
        });

        // View toggle
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const gallery = document.getElementById('gallery');
                gallery.className = 'gallery';
                if (btn.dataset.view !== 'grid') {
                    gallery.classList.add(btn.dataset.view);
                }
                if (btn.dataset.view === 'masonry') {
                    setTimeout(updateMasonryLayout, 300);
                }
            });
        });

        // Update masonry layout
        function updateMasonryLayout() {
            const gallery = document.getElementById('gallery');
            if (!gallery.classList.contains('masonry')) return;
            
            const items = document.querySelectorAll('.gallery-item');
            
            items.forEach(item => {
                item.style.setProperty('--row-span', 'auto');
                
                const setRowSpan = () => {
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            const rowSpan = Math.ceil((item.offsetHeight + 20) / 10);
                            item.style.setProperty('--row-span', rowSpan);
                        });
                    });
                };
                
                setRowSpan();
            });
        }

        // Scroll to top button
        window.addEventListener('scroll', () => {
            const scrollTop = document.getElementById('scroll-top');
            if (window.pageYOffset > 300) {
                scrollTop.classList.add('visible');
            } else {
                scrollTop.classList.remove('visible');
            }
        });

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Initialize
        loadStats();
        loadImages().then(() => {
            // Populate LoRA filter after images are loaded
            populateLoRAFilter();
        });

        // Add event listeners for filters
        document.getElementById('filter-date-from').addEventListener('change', applyFilters);
        document.getElementById('filter-date-to').addEventListener('change', applyFilters);
        document.getElementById('filter-lora').addEventListener('change', applyFilters);
        document.getElementById('filter-dimensions').addEventListener('change', applyFilters);
        document.getElementById('filter-featured').addEventListener('change', applyFilters);

        // ============================================================
        // Live Preview - WebSocket Integration
        // ============================================================
        
        let ws = null;
        let currentSessionId = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                reconnectAttempts = 0;
                // Send ping to keep alive
                ws.send(JSON.stringify({ type: 'ping' }));
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                // Attempt reconnect with exponential backoff
                if (reconnectAttempts < maxReconnectAttempts) {
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
                    reconnectAttempts++;
                    console.log(`Reconnecting in ${delay}ms... (attempt ${reconnectAttempts}/${maxReconnectAttempts})`);
                    setTimeout(connectWebSocket, delay);
                }
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'generation_progress':
                    updateProgress(data);
                    break;
                case 'generation_complete':
                    handleGenerationComplete(data);
                    break;
                case 'generation_error':
                    handleGenerationError(data);
                    break;
                case 'pong':
                    // Keep alive response
                    break;
            }
        }

        function updateProgress(data) {
            const panel = document.getElementById('progress-panel');
            const bar = document.getElementById('progress-bar');
            const stepText = document.getElementById('progress-step-text');
            const percentText = document.getElementById('progress-percent-text');
            const message = document.getElementById('progress-message');
            const cancelBtn = document.getElementById('cancel-btn');
            
            panel.classList.add('active');
            cancelBtn.disabled = false;
            
            const percent = data.progress_percent || Math.round((data.step / data.total_steps) * 100);
            bar.style.width = `${percent}%`;
            stepText.textContent = `Step ${data.step} of ${data.total_steps}`;
            percentText.textContent = `${percent}%`;
            message.textContent = data.message || 'Generating...';
            
            currentSessionId = data.session_id;
        }

        function handleGenerationComplete(data) {
            const panel = document.getElementById('progress-panel');
            const status = document.getElementById('progress-status');
            const message = document.getElementById('progress-message');
            const cancelBtn = document.getElementById('cancel-btn');
            const bar = document.getElementById('progress-bar');
            const percentText = document.getElementById('progress-percent-text');
            
            bar.style.width = '100%';
            percentText.textContent = '100%';
            status.textContent = 'Complete';
            status.style.background = 'rgba(76, 175, 80, 0.2)';
            status.style.color = '#4caf50';
            message.textContent = `Generated ${data.image_paths.length} image(s) successfully!`;
            cancelBtn.disabled = true;
            
            // Reload gallery to show new images
            setTimeout(() => {
                loadImages();
                showToast(`New artwork created!`, 'success');
            }, 1000);
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                panel.classList.remove('active');
                // Reset UI
                setTimeout(() => {
                    bar.style.width = '0%';
                    status.textContent = 'In Progress';
                    status.style.background = 'rgba(0, 217, 255, 0.2)';
                    status.style.color = 'var(--accent)';
                }, 300);
            }, 3000);
            
            currentSessionId = null;
        }

        function handleGenerationError(data) {
            const status = document.getElementById('progress-status');
            const message = document.getElementById('progress-message');
            const cancelBtn = document.getElementById('cancel-btn');
            
            status.textContent = 'Error';
            status.style.background = 'rgba(244, 67, 54, 0.2)';
            status.style.color = '#f44336';
            message.textContent = `Error: ${data.error}`;
            cancelBtn.disabled = true;
            
            showToast('Generation failed', 'error');
            
            currentSessionId = null;
        }

        function hideProgressPanel() {
            document.getElementById('progress-panel').classList.remove('active');
        }

        function cancelGeneration() {
            if (currentSessionId) {
                // Send cancel request if API supports it
                fetch(`/api/cancel/${currentSessionId}`, { method: 'POST' })
                    .then(() => {
                        showToast('Generation cancelled', 'success');
                        hideProgressPanel();
                    })
                    .catch((error) => {
                        console.error('Failed to cancel:', error);
                        showToast('Failed to cancel generation', 'error');
                    });
                
                currentSessionId = null;
            }
        }

        // Connect WebSocket on page load
        connectWebSocket();
        
        // Keep connection alive with periodic pings
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'ping' }));
            }
        }, 30000); // Ping every 30 seconds
    </script>
</body>
</html>
